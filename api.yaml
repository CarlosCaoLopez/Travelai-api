openapi: 3.0.3
info:
  title: Art Explorer API
  description: API para la aplicaci贸n de exploraci贸n de arte, gesti贸n de colecciones de usuarios y cat谩logo de obras.
  version: 1.0.0
servers:
  - url: https://api.artexplorer.com
    description: Servidor de Producci贸n

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

    webhookSecret:
      type: apiKey
      in: header
      name: x-webhook-secret
      description: Secret key for validating Supabase webhook requests

  schemas:
    # --- Common Types ---
    UUID:
      type: string
      format: uuid
      example: '550e8400-e29b-41d4-a716-446655440000'

    CategoryObject:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        icon:
          type: string

    CategoryWithRelations:
      type: object
      description: 'Categor铆a con su jerarqu铆a de relaciones (padres e hijos)'
      required:
        - id
        - name
        - type
        - icon
        - sortOrder
        - parentIds
        - childIds
        - updatedAt
      properties:
        id:
          type: string
          example: 'pintura'
          description: 'ID 煤nico de la categor铆a'
        name:
          type: string
          description: 'Nombre localizado de la categor铆a seg煤n el par谩metro language'
          example: 'Pintura'
        type:
          type: string
          enum: [category, subcategory]
          example: 'category'
          description: "Tipo de categor铆a: 'category' (principal) o 'subcategory' (per铆odo art铆stico)"
        icon:
          type: string
          description: 'Emoji que representa la categor铆a'
          example: ''
        imageUrl:
          type: string
          nullable: true
          description: 'URL opcional de imagen representativa'
          example: null
        sortOrder:
          type: integer
          example: 1
          description: 'Orden de visualizaci贸n (menor = primero)'
        parentIds:
          type: array
          items:
            type: string
          description: 'IDs de las categor铆as padre (vac铆o para categor铆as principales)'
          example: []
        childIds:
          type: array
          items:
            type: string
          description: 'IDs de las subcategor铆as hijas (vac铆o para subcategor铆as)'
          example:
            [
              'antiguedad-romana-griega',
              'renacimiento',
              'barroco',
              'impresionismo-postimpresionismo',
            ]
        updatedAt:
          type: string
          format: date-time
          example: '2025-12-04T10:30:00Z'
          description: 'ltima actualizaci贸n para sincronizaci贸n incremental'

    # --- Home Screen ---
    Quote:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/UUID'
        text:
          type: string
          example: 'El arte es la mentira que nos permite conocer la verdad'
        author:
          type: string
          example: 'Pablo Picasso'

    # --- Explore/Locations ---
    LocationSpot:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        description:
          type: string
        category:
          type: string
        distance:
          type: integer
          description: Distancia en metros
        estimatedTime:
          type: string

    # --- Artworks (Catalog) ---
    Artwork:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/UUID'
        title:
          type: string
        author:
          type: string
        year:
          type: string
        country:
          type: string
        period:
          type: string
        technique:
          type: string
        dimensions:
          type: string
        imageUrl:
          type: string
          format: uri
        description:
          type: string
        category:
          $ref: '#/components/schemas/CategoryObject'
        subcategory:
          $ref: '#/components/schemas/CategoryObject'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    # --- User Collection ---
    UserIdentifiedArtwork:
      allOf:
        - $ref: '#/components/schemas/Artwork'
        - type: object
          properties:
            capturedImageUrl:
              type: string
              format: uri
            identifiedAt:
              type: string
              format: date-time

    IdentifyArtworkRequest:
      type: object
      required:
        - capturedImageUrl
        - country
        - category_id
        - subcategory_id
        - title
        - author
        - image_url
      properties:
        capturedImageUrl:
          type: string
          format: uri
        country:
          type: string
        category_id:
          type: string
        subcategory_id:
          type: string
        title:
          type: string
        author:
          type: string
        year:
          type: string
        dimensions:
          type: string
        technique:
          type: string
        image_url:
          type: string # URL de referencia (no la capturada)

    CollectionStats:
      type: object
      properties:
        totalArtworks:
          type: integer
        totalArtists:
          type: integer

    CollectionSummary:
      type: object
      properties:
        stats:
          $ref: '#/components/schemas/CollectionStats'
        artistsInCollection:
          type: array
          items:
            type: object
            properties:
              artist:
                type: string
              artworkCount:
                type: integer
        countriesInCollection:
          type: array
          items:
            type: object
            properties:
              country:
                type: string
              artworkCount:
                type: integer

    # --- Camera Recognition ---
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: 'Invalid image format'
        message:
          type: string
          example: 'The uploaded file must be a valid JPG, PNG, or HEIC image'

    RecognizeArtworkRequest:
      type: object
      required:
        - image
        - localUri
      properties:
        image:
          type: string
          format: binary
          description: 'Imagen capturada del monumento u obra de arte (JPG, PNG, HEIC - m谩ximo 10MB)'
        localUri:
          type: string
          description: 'URI local del dispositivo donde se guard贸 la imagen (file:// o content://)'
          example: 'file:///storage/emulated/0/DCIM/Camera/IMG_20241209_153045.jpg'

    RecognizedArtworkData:
      type: object
      description: 'Datos de la obra identificada - null si no se pudo identificar'
      nullable: true
      properties:
        id:
          $ref: '#/components/schemas/UUID'
        title:
          type: string
          example: 'Las Meninas'
        artist:
          type: string
          example: 'Diego Vel谩zquez'
        year:
          type: string
          example: '1656'
        period:
          type: string
          example: 'Spanish Baroque'
          description: 'Per铆odo art铆stico o movimiento'
        description:
          type: string
          example: 'One of the masterpieces of the Spanish Golden Age. It shows Infanta Margaret surrounded by her ladies-in-waiting (meninas) and other members of the court, including the painter himself. The complex composition with multiple viewpoints, the masterful use of light, and the mirror reflecting King Philip IV and Queen Mariana of Austria, challenge the perception of space and reality.'
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
          example: 0.98
          description: 'Nivel de confianza del reconocimiento (0.0 - 1.0)'
        tags:
          type: array
          items:
            type: string
          example:
            [
              'Spanish Baroque',
              'Court Portrait',
              'Oil on Canvas',
              '17th Century',
              'Prado Museum',
            ]
          description: 'Categor铆as, estilos y metadata adicional'
        capturedImageUrl:
          type: string
          example: 'file:///storage/emulated/0/DCIM/Camera/IMG_20241209_153045.jpg'
          description: 'URI local del dispositivo donde se encuentra la imagen capturada'
        identifiedAt:
          type: string
          format: date-time
          example: '2025-11-30T14:30:00Z'

    RecognizedArtworkResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
          description: 'Indica si la operaci贸n fue exitosa a nivel t茅cnico'
        identified:
          type: boolean
          example: true
          description: 'Indica si la obra fue identificada por la IA (true) o no se pudo reconocer (false)'
        artwork:
          $ref: '#/components/schemas/RecognizedArtworkData'
        savedToCollection:
          type: boolean
          example: true
          description: 'Indica si la obra se guard贸 en la colecci贸n del usuario (solo true si identified=true)'
        message:
          type: string
          example: 'Artwork successfully identified and saved to collection'
          description: 'Mensaje descriptivo del resultado para el usuario'

    # --- Users ---
    User:
      type: object
      description: 'Datos del perfil del usuario'
      required:
        - id
        - email
        - preferredLanguage
        - isPremium
        - createdAt
      properties:
        id:
          $ref: '#/components/schemas/UUID'
          description: 'UUID del usuario (mismo que en Supabase Auth)'
        email:
          type: string
          format: email
          example: 'user@example.com'
        displayName:
          type: string
          example: 'John Doe'
          nullable: true
          description: 'Nombre visible del usuario'
        preferredLanguage:
          type: string
          enum: [es, en]
          example: 'es'
          description: 'Idioma preferido del usuario (detectado autom谩ticamente al registrarse)'
        isPremium:
          type: boolean
          example: false
          description: 'Indica si el usuario tiene suscripci贸n premium activa'
        allowDataCollection:
          type: boolean
          nullable: true
          example: true
          description: 'Permiso para guardar fotos del usuario para mejorar la IA de reconocimiento (null = no se ha preguntado, true = permitido, false = rechazado)'
        createdAt:
          type: string
          format: date-time
          example: '2025-12-01T20:00:00Z'
          description: 'Fecha de creaci贸n de la cuenta'

    UpdateUserRequest:
      type: object
      description: 'Datos para actualizar el perfil del usuario'
      properties:
        displayName:
          type: string
          example: 'Jane Smith'
          nullable: true
        preferredLanguage:
          type: string
          enum: [es, en]
          example: 'en'
          description: 'Cambiar idioma preferido del usuario'
        allowDataCollection:
          type: boolean
          nullable: true
          example: true
          description: 'Permiso para guardar fotos para mejorar la IA de reconocimiento'

    DeleteAccountRequest:
      type: object
      description: 'Datos para confirmar la eliminaci贸n de cuenta'
      required:
        - confirmationUserId
      properties:
        confirmationUserId:
          type: string
          example: '123e4567-e89b-12d3-a456-426614174000'
          description: 'ID del usuario para confirmar la eliminaci贸n (debe coincidir con el usuario autenticado)'

    DeleteAccountResponse:
      type: object
      description: 'Respuesta de eliminaci贸n de cuenta exitosa'
      required:
        - success
        - message
        - deletedAt
      properties:
        success:
          type: boolean
          example: true
          description: 'Indica si la eliminaci贸n fue exitosa'
        message:
          type: string
          example: 'Your account has been successfully deleted'
          description: 'Mensaje de confirmaci贸n'
        deletedAt:
          type: string
          format: date-time
          example: '2025-12-22T15:30:00Z'
          description: 'Timestamp de cu谩ndo se elimin贸 la cuenta'

    # --- Webhooks ---
    SupabaseWebhookPayload:
      type: object
      description: 'Payload enviado por Supabase cuando se crea un nuevo usuario'
      required:
        - type
        - table
        - record
        - schema
      properties:
        type:
          type: string
          enum: [INSERT, UPDATE, DELETE]
          example: 'INSERT'
          description: 'Tipo de evento de base de datos'
        table:
          type: string
          example: 'users'
          description: 'Nombre de la tabla afectada'
        record:
          type: object
          description: 'Datos del usuario creado en Supabase Auth'
          required:
            - id
            - email
          properties:
            id:
              $ref: '#/components/schemas/UUID'
              description: 'UUID del usuario en Supabase Auth (usarlo como PK en tabla local)'
            email:
              type: string
              format: email
              example: 'user@example.com'
            raw_user_meta_data:
              type: object
              description: 'Metadata adicional del perfil del usuario'
              properties:
                displayName:
                  type: string
                  example: 'John Doe'
                  nullable: true
                language:
                  type: string
                  enum: [es, en]
                  example: 'es'
                  description: 'Idioma detectado del dispositivo al momento del registro'
                  nullable: false
            created_at:
              type: string
              format: date-time
              example: '2025-12-01T20:00:00Z'
        schema:
          type: string
          example: 'auth'
          description: "Schema de la base de datos (siempre 'auth' para usuarios de Supabase)"
        old_record:
          type: object
          nullable: true
          description: 'Registro anterior (null para INSERT events)'

    WebhookSuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: 'User created successfully'
        userId:
          $ref: '#/components/schemas/UUID'

    # --- Payments/Subscriptions ---
    CreatePaymentIntentRequest:
      type: object
      description: 'Request body para crear Payment Intent de Travel Pass'
      required:
        - planId
      properties:
        planId:
          type: string
          enum: [travel_pass]
          description: 'Identificador del plan - solo se acepta travel_pass para payment intents'
          example: 'travel_pass'
        currency:
          type: string
          default: 'eur'
          description: 'C贸digo de moneda (ISO 4217)'
          example: 'eur'

    PaymentSheetResponse:
      type: object
      description: 'Credenciales para inicializar Stripe Payment Sheet en el cliente'
      required:
        - paymentIntent
        - ephemeralKey
        - customer
        - publishableKey
      properties:
        paymentIntent:
          type: string
          description: 'Payment Intent client_secret (comienza con pi_)'
          example: 'pi_3QLxyz123_secret_xyz789abc'
        ephemeralKey:
          type: string
          description: 'Ephemeral Key secret para autenticaci贸n del Stripe SDK'
          example: 'ek_test_YWJjZGVm'
        customer:
          type: string
          description: 'Stripe Customer ID (comienza con cus_)'
          example: 'cus_QtPxyz123ABC'
        publishableKey:
          type: string
          description: 'Stripe publishable key para inicializar el SDK'
          example: 'pk_test_51xyz...'

    CreateSetupIntentRequest:
      type: object
      description: 'Request body para crear SetupIntent de suscripci贸n (Paso 1/2)'
      required:
        - planId
      properties:
        planId:
          type: string
          enum: [monthly, annual]
          description: 'Identificador del plan de suscripci贸n'
          example: 'monthly'

    SetupIntentResponse:
      type: object
      description: 'Credenciales para inicializar Stripe SetupIntent Sheet en el cliente'
      required:
        - setupIntent
        - ephemeralKey
        - customer
        - publishableKey
      properties:
        setupIntent:
          type: string
          description: 'SetupIntent client_secret (comienza con seti_)'
          example: 'seti_1QLxyz123_secret_abc789xyz'
        ephemeralKey:
          type: string
          description: 'Ephemeral Key secret para autenticaci贸n del Stripe SDK'
          example: 'ek_test_YWJjZGVm'
        customer:
          type: string
          description: 'Stripe Customer ID (comienza con cus_)'
          example: 'cus_QtPxyz123ABC'
        publishableKey:
          type: string
          description: 'Stripe publishable key para inicializar el SDK'
          example: 'pk_test_51xyz...'

    CreateSubscriptionRequest:
      type: object
      description: 'Request body para crear suscripci贸n con m茅todo de pago guardado (Paso 2/2)'
      required:
        - planId
      properties:
        planId:
          type: string
          enum: [monthly, annual]
          description: 'Identificador del plan de suscripci贸n'
          example: 'monthly'
        setupIntentId:
          type: string
          pattern: '^seti_[a-zA-Z0-9_]+$'
          description: 'Opcional: SetupIntent ID para extraer m茅todo de pago (comienza con seti_)'
          example: 'seti_1QLxyz123abc'

    SubscriptionCreatedResponse:
      type: object
      description: 'Respuesta al crear una suscripci贸n exitosamente'
      required:
        - subscriptionId
        - status
        - currentPeriodEnd
      properties:
        subscriptionId:
          type: string
          description: 'Stripe Subscription ID (comienza con sub_)'
          example: 'sub_1QLxyzABC123'
        status:
          type: string
          description: 'Estado actual de la suscripci贸n'
          example: 'active'
        currentPeriodEnd:
          type: string
          format: date-time
          description: 'Fecha ISO 8601 cuando termina el per铆odo de facturaci贸n actual'
          example: '2026-01-15T14:30:00.000Z'

    SubscriptionStatusResponse:
      type: object
      description: 'Estado actual de la suscripci贸n o compra del usuario'
      required:
        - plan
        - status
        - isSubscribed
      properties:
        plan:
          type: string
          enum: [monthly, annual]
          nullable: true
          description: 'Tipo de plan de suscripci贸n (null para travel_pass o sin suscripci贸n)'
          example: 'monthly'
        status:
          type: string
          enum: [active, expired, canceled, past_due, none]
          description: 'Estado actual de la suscripci贸n o compra'
          example: 'active'
        expiryDate:
          type: string
          format: date-time
          nullable: true
          description: 'Fecha ISO 8601 cuando expira la suscripci贸n o compra'
          example: '2026-01-15T14:30:00.000Z'
        isSubscribed:
          type: boolean
          description: 'True si el usuario tiene acceso premium activo actualmente'
          example: true

    StripeWebhookEvent:
      type: object
      description: 'Payload de evento webhook de Stripe'
      required:
        - type
        - data
      properties:
        type:
          type: string
          description: 'Tipo de evento de Stripe'
          example: 'payment_intent.succeeded'
        data:
          type: object
          description: 'Datos del evento conteniendo el objeto de Stripe'

paths:
  # ----------------------------
  # HOME SCREEN
  # ----------------------------
  /api/home/quotes:
    get:
      tags:
        - Home
      summary: Obtener citas de artistas
      parameters:
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
          description: C贸digo ISO 639-1 (es, en, fr)
      responses:
        '200':
          description: Lista de citas
          content:
            application/json:
              schema:
                type: object
                properties:
                  quotes:
                    type: array
                    items:
                      $ref: '#/components/schemas/Quote'

  # ----------------------------
  # CAMERA RECOGNITION
  # ----------------------------
  /api/camera/recognize:
    post:
      tags:
        - Camera Recognition
      summary: Reconocer monumento u obra de arte desde imagen capturada
      description: |
        Recibe una imagen capturada por el usuario, la procesa mediante IA para identificar
        el monumento u obra de arte, y autom谩ticamente la guarda en la colecci贸n del usuario
        si es reconocida exitosamente.

        **Flujo:**
        1. Usuario captura foto desde la c谩mara y la guarda localmente en el dispositivo
        2. Frontend env铆a imagen (para an谩lisis) y localUri (para almacenamiento) como multipart/form-data
        3. Backend procesa imagen con IA y busca coincidencias
        4. Si identifica: guarda localUri en colecci贸n y retorna datos completos
        5. Si no identifica: retorna identified=false con mensaje descriptivo

        **Limitaciones:**
        - Tama帽o m谩ximo: 10MB
        - Formatos soportados: JPG, PNG, HEIC
        - Rate limiting aplicado seg煤n tier de suscripci贸n del usuario
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: language
          schema:
            type: string
            pattern: '^[a-z]{2}$'
            default: 'es'
          description: C贸digo ISO 639-1 del idioma (es, en, fr) para los resultados
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/RecognizeArtworkRequest'
            encoding:
              image:
                contentType: image/jpeg, image/png, image/heic
      responses:
        '200':
          description: |
            Operaci贸n exitosa - puede indicar obra identificada (identified=true)
            o no identificada (identified=false)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecognizedArtworkResponse'
              examples:
                identified:
                  summary: Obra identificada exitosamente
                  value:
                    success: true
                    identified: true
                    artwork:
                      id: '550e8400-e29b-41d4-a716-446655440000'
                      title: 'Las Meninas'
                      artist: 'Diego Vel谩zquez'
                      year: '1656'
                      period: 'Spanish Baroque'
                      description: 'One of the masterpieces of the Spanish Golden Age. It shows Infanta Margaret surrounded by her ladies-in-waiting (meninas) and other members of the court, including the painter himself. The complex composition with multiple viewpoints, the masterful use of light, and the mirror reflecting King Philip IV and Queen Mariana of Austria, challenge the perception of space and reality.'
                      confidence: 0.98
                      tags:
                        [
                          'Spanish Baroque',
                          'Court Portrait',
                          'Oil on Canvas',
                          '17th Century',
                          'Prado Museum',
                        ]
                      capturedImageUrl: 'https://storage.artexplorer.com/captures/user123/abc123.jpg'
                      identifiedAt: '2025-11-30T14:30:00Z'
                    savedToCollection: true
                    message: 'Artwork successfully identified and saved to collection'
                not_identified:
                  summary: Obra no pudo ser identificada
                  value:
                    success: true
                    identified: false
                    artwork: null
                    savedToCollection: false
                    message: 'Artwork could not be identified. Try with better lighting or a different angle.'
        '400':
          description: Solicitud inv谩lida - imagen corrupta, formato no soportado, etc.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_format:
                  summary: Formato de imagen no v谩lido
                  value:
                    success: false
                    error: 'invalid_image_format'
                    message: 'The uploaded file must be a valid JPG, PNG, or HEIC image'
                missing_image:
                  summary: Falta el campo image
                  value:
                    success: false
                    error: 'missing_required_field'
                    message: "The 'image' field is required"
        '401':
          description: No autenticado - token JWT inv谩lido o faltante
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Valid authentication token required'
        '413':
          description: Payload demasiado grande - imagen excede 10MB
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'payload_too_large'
                message: 'Image file size must not exceed 10MB'
        '429':
          description: Demasiadas solicitudes - rate limit excedido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'rate_limit_exceeded'
                message: 'Recognition limit reached. Upgrade to premium for unlimited scans.'
        '500':
          description: Error interno del servidor - fallo en procesamiento IA o base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'An unexpected error occurred while processing the image. Please try again.'

  /api/camera/artwork/details:
    post:
      tags:
        - Camera Recognition
      summary: Obtener informaci贸n detallada de una obra identificada
      description: |
        Recibe informaci贸n b谩sica de una obra (t铆tulo, autor, descripci贸n) y retorna
        informaci贸n enriquecida adicional como contexto hist贸rico, t茅cnica, ubicaci贸n,
        obras relacionadas, y datos curiosos.

        **Uso t铆pico:**
        - Usuario ve la informaci贸n inicial de una obra identificada
        - Usuario solicita "m谩s informaci贸n" sobre la obra
        - Frontend env铆a los datos b谩sicos disponibles
        - Backend enriquece con contexto adicional mediante IA y bases de datos

        **Limitaciones:**
        - Rate limiting aplicado seg煤n tier de suscripci贸n
        - Requiere al menos t铆tulo o autor para funcionar
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: language
          schema:
            type: string
            pattern: '^[a-z]{2}$'
            default: 'es'
          description: C贸digo ISO 639-1 del idioma (es, en, fr) para los resultados enriquecidos
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
              properties:
                title:
                  type: string
                  description: T铆tulo de la obra
                  example: 'Las Meninas'
                artist:
                  type: string
                  description: Nombre del artista/creador
                  example: 'Diego Vel谩zquez'
                description:
                  type: string
                  description: Descripci贸n inicial de la obra
                  example: 'One of the masterpieces of the Spanish Golden Age...'
                year:
                  type: string
                  description: A帽o de creaci贸n (opcional)
                  example: '1656'
                artworkId:
                  type: string
                  description: ID de la obra en la base de datos (si ya fue identificada previamente)
                  example: '550e8400-e29b-41d4-a716-446655440000'
      responses:
        '200':
          description: Informaci贸n detallada obtenida exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  detailedInfo:
                    type: object
                    properties:
                      historicalContext:
                        type: string
                        description: Contexto hist贸rico y cultural de la 茅poca
                        example: 'Created during the reign of Philip IV of Spain, during the Spanish Golden Age...'
                      visualDescription:
                        type: string
                        description: Descripci贸n visual detallada de la obra (composici贸n, colores, elementos, figuras)
                        example: 'The painting depicts a large room in the Royal Alcazar of Madrid. In the center, the Infanta Margarita Teresa is surrounded by her ladies-in-waiting...'
                      symbolism:
                        type: string
                        description: Simbolismo e interpretaci贸n de la obra
                        example: 'The mirror in the background reflects the royal couple, suggesting multiple perspectives...'
                      interestingFacts:
                        type: array
                        items:
                          type: string
                        example:
                          - 'Picasso created 58 interpretations of Las Meninas in 1957'
                          - 'The painting includes a self-portrait of Vel谩zquez himself'
                          - 'It was originally titled "The Family of Philip IV"'
                      artistBio:
                        type: string
                        description: Breve biograf铆a del artista
                        example: 'Diego Rodr铆guez de Silva y Vel谩zquez (1599-1660) was a Spanish painter...'
        '400':
          description: Solicitud inv谩lida - faltan campos requeridos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'missing_required_field'
                message: 'Title is required to fetch artwork details'
        '401':
          description: No autenticado - token JWT inv谩lido o faltante
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Valid authentication token required'
        '404':
          description: Obra no encontrada en la base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'artwork_not_found'
                message: 'Could not find detailed information for the specified artwork'
        '429':
          description: Demasiadas solicitudes - rate limit excedido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'rate_limit_exceeded'
                message: 'Detail request limit reached. Please try again later.'
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'An unexpected error occurred while fetching artwork details'

  # ----------------------------
  # EXPLORE SCREEN
  # ----------------------------

  /api/explore/locations/nearby:
    get:
      tags:
        - Explore
      summary: Obtener lugares culturales cercanos
      parameters:
        - in: query
          name: latitude
          required: true
          schema:
            type: number
            format: float
        - in: query
          name: longitude
          required: true
          schema:
            type: number
            format: float
        - in: query
          name: maxDistance
          schema:
            type: integer
            default: 5000
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
        - in: query
          name: limit
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: Lista de lugares cercanos
          content:
            application/json:
              schema:
                type: object
                properties:
                  locations:
                    type: array
                    items:
                      $ref: '#/components/schemas/LocationSpot'
                  count:
                    type: integer

  /api/explore/artworks:
    get:
      tags:
        - Explore
      summary: Listar obras del cat谩logo por categor铆a/pa铆s
      parameters:
        - in: query
          name: category_id
          schema:
            type: string
        - in: query
          name: subcategory_id
          schema:
            type: string
        - in: query
          name: country
          schema:
            type: string
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Lista paginada de obras
          content:
            application/json:
              schema:
                type: object
                properties:
                  artworks:
                    type: array
                    items:
                      $ref: '#/components/schemas/Artwork'
                  pagination:
                    type: object
                    properties:
                      total:
                        type: integer
                      limit:
                        type: integer
                      offset:
                        type: integer
                      hasMore:
                        type: boolean
                  filters:
                    type: object

  # ----------------------------
  # ARTWORKS (CATALOG)
  # ----------------------------
  /api/artworks/{id}:
    get:
      tags:
        - Artworks Catalog
      summary: Obtener detalle de una obra espec铆fica
      parameters:
        - in: path
          name: id
          required: true
          schema:
            $ref: '#/components/schemas/UUID'
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
      responses:
        '200':
          description: Detalle de la obra
          content:
            application/json:
              schema:
                type: object
                properties:
                  artwork:
                    $ref: '#/components/schemas/Artwork'

  /api/artworks/search:
    get:
      tags:
        - Artworks Catalog
      summary: Buscar obras por t铆tulo o autor
      parameters:
        - in: query
          name: q
          required: true
          schema:
            type: string
          description: Query de b煤squeda
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Resultados de b煤squeda
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/Artwork'
                  pagination:
                    type: object
                    properties:
                      total:
                        type: integer
                      limit:
                        type: integer
                      offset:
                        type: integer
                      hasMore:
                        type: boolean
                  query:
                    type: string

  /api/artworks/daily-recommendation:
    get:
      tags:
        - Artworks Catalog
      summary: Obtener recomendaci贸n diaria de obra de arte
      description: |
        Retorna una obra de arte seleccionada aleatoriamente como recomendaci贸n del d铆a.

        **Caracter铆sticas:**
        - La recomendaci贸n se genera autom谩ticamente y es la misma para todos los usuarios durante el d铆a
        - Se renueva autom谩ticamente cada d铆a
        - Requiere autenticaci贸n JWT
        - Soporta m煤ltiples idiomas para las traducciones

        **Cache:**
        - La recomendaci贸n se cachea en memoria para optimizar rendimiento
        - Cache v谩lido hasta que cambie la fecha (UTC)
        - Si el servidor se reinicia, se genera una nueva recomendaci贸n autom谩ticamente
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
          description: C贸digo ISO 639-1 del idioma (es, en, fr) para obtener las traducciones
      responses:
        '200':
          description: Recomendaci贸n diaria obtenida exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  artwork:
                    $ref: '#/components/schemas/Artwork'
              example:
                artwork:
                  id: '550e8400-e29b-41d4-a716-446655440000'
                  title: 'La noche estrellada'
                  author: 'Vincent van Gogh'
                  year: '1889'
                  country: 'Francia'
                  period: 'Postimpresionismo'
                  technique: 'leo sobre lienzo'
                  dimensions: '73.7 cm  92.1 cm'
                  imageUrl: 'https://example.com/starry-night.jpg'
                  description: 'Una de las pinturas m谩s famosas del arte moderno...'
                  category:
                    id: 'pintura'
                    name: 'Pintura'
                    icon: ''
                  createdAt: '2025-01-01T00:00:00Z'
                  updatedAt: '2025-01-01T00:00:00Z'
        '401':
          description: No autenticado - JWT inv谩lido o no proporcionado
          content:
            application/json:
              schema:
                type: object
                properties:
                  statusCode:
                    type: integer
                    example: 401
                  message:
                    type: string
                    example: 'Unauthorized'

  # ----------------------------
  # USER COLLECTION
  # ----------------------------
  /api/user/collection:
    get:
      tags:
        - User Collection
      summary: Resumen de la colecci贸n del usuario
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
      responses:
        '200':
          description: Estad铆sticas y grupos de la colecci贸n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CollectionSummary'

  /api/user/collection/artist/{artistName}:
    get:
      tags:
        - User Collection
      summary: Obtener obras de usuario filtradas por artista
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: artistName
          required: true
          schema:
            type: string
          description: Nombre del artista (URL encoded)
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
      responses:
        '200':
          description: Obras del artista en la colecci贸n
          content:
            application/json:
              schema:
                type: object
                properties:
                  artist:
                    type: string
                  artworkCount:
                    type: integer
                  artworks:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserIdentifiedArtwork'

  /api/user/collection/country/{countryName}:
    get:
      tags:
        - User Collection
      summary: Obtener obras de usuario filtradas por pa铆s
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: countryName
          required: true
          schema:
            type: string
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
      responses:
        '200':
          description: Obras del pa铆s en la colecci贸n
          content:
            application/json:
              schema:
                type: object
                properties:
                  country:
                    type: string
                  artworkCount:
                    type: integer
                  artworks:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserIdentifiedArtwork'

  /api/user/collection/recent:
    get:
      tags:
        - User Collection
      summary: Obtener obras recientemente identificadas
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            default: 3
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
      responses:
        '200':
          description: Lista de obras recientes
          content:
            application/json:
              schema:
                type: object
                properties:
                  artworks:
                    type: array
                    items:
                      # Nota: La respuesta de ejemplo muestra una versi贸n simplificada,
                      # pero usaremos el esquema completo para consistencia o una versi贸n parcial inline
                      type: object
                      properties:
                        id:
                          $ref: '#/components/schemas/UUID'
                        title:
                          type: string
                        author:
                          type: string
                        capturedImageUrl:
                          type: string
                        identifiedAt:
                          type: string
                          format: date-time

  /api/user/collection/identify:
    post:
      tags:
        - User Collection
      summary: Guardar una obra identificada en la colecci贸n
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IdentifyArtworkRequest'
      responses:
        '200':
          description: Obra guardada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  artwork:
                    $ref: '#/components/schemas/UserIdentifiedArtwork'
                  updatedStats:
                    $ref: '#/components/schemas/CollectionStats'

  /api/user/collection/{id}:
    delete:
      tags:
        - User Collection
      summary: Eliminar una obra de la colecci贸n
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            $ref: '#/components/schemas/UUID'
      responses:
        '200':
          description: Obra eliminada
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                  deletedId:
                    $ref: '#/components/schemas/UUID'
                  updatedStats:
                    $ref: '#/components/schemas/CollectionStats'

  # ----------------------------
  # SYNC
  # ----------------------------
  /api/sync/users/me:
    get:
      tags:
        - Users
      summary: Obtener perfil del usuario autenticado
      description: |
        Retorna la informaci贸n del perfil del usuario actual.

        **Uso en la app:**
        - Se llama autom谩ticamente despu茅s del login para sincronizar datos con SQLite local
        - Los datos se cachean localmente para acceso offline
        - El backend es la fuente de verdad para el perfil del usuario
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Perfil del usuario
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
              example:
                id: '550e8400-e29b-41d4-a716-446655440000'
                email: 'user@example.com'
                displayName: 'John Doe'
                preferredLanguage: 'es'
                isPremium: false
                allowDataCollection: null
                createdAt: '2025-12-01T20:00:00Z'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'Unauthorized'
                message: 'No authentication token provided'

    patch:
      tags:
        - Users
      summary: Actualizar perfil del usuario autenticado
      description: |
        Actualiza la informaci贸n del perfil del usuario actual.

        **Campos actualizables:**
        - `displayName`: Nombre visible del usuario
        - `preferredLanguage`: Idioma preferido (es/en)
        - `allowDataCollection`: Permiso para guardar fotos para mejora de IA (true/false/null)

        **Notas:**
        - Solo se actualizan los campos proporcionados (PATCH parcial)
        - El cambio de idioma afecta el contenido personalizado (quotes, descripciones)
        - La app debe sincronizar los cambios con SQLite local despu茅s de actualizar
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
            examples:
              update_language:
                summary: Cambiar idioma preferido
                value:
                  preferredLanguage: 'en'
              update_profile:
                summary: Actualizar nombre
                value:
                  displayName: 'Jane Smith'
              update_all:
                summary: Actualizar todos los campos
                value:
                  displayName: 'Jane Smith'
                  preferredLanguage: 'en'
                  allowDataCollection: true
      responses:
        '200':
          description: Perfil actualizado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
              example:
                id: '550e8400-e29b-41d4-a716-446655440000'
                email: 'user@example.com'
                displayName: 'Jane Smith'
                preferredLanguage: 'en'
                isPremium: false
                allowDataCollection: true
                createdAt: '2025-12-01T20:00:00Z'
        '400':
          description: Datos inv谩lidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'Validation Error'
                message: "preferredLanguage must be 'es' or 'en'"
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'Unauthorized'
                message: 'No authentication token provided'

    delete:
      tags:
        - Users
      summary: Eliminar cuenta de usuario (GDPR/CCPA compliant)
      description: |
        Elimina permanentemente la cuenta del usuario cumpliendo con regulaciones GDPR y CCPA.

        **Proceso de eliminaci贸n:**
        1. Valida que el email de confirmaci贸n coincida con el email del usuario
        2. Elimina el usuario de Supabase Auth (no podr谩 volver a autenticarse)
        3. Anonimiza datos personales en la base de datos
        4. Elimina tokens de notificaciones push
        5. Preserva colecciones de arte (im谩genes) de forma an贸nima
        6. Preserva registros financieros (subscripciones/compras) anonimizados para cumplimiento legal

        **Datos eliminados:**
        - Email (reemplazado por `deleted_<userId>@deleted.travelai.com`)
        - Nombre visible (`displayName`)
        - Idioma preferido
        - Permisos de recolecci贸n de datos
        - Tokens de notificaciones push
        - Usuario de Supabase Auth

        **Datos preservados (anonimizados):**
        - Registros de subscripciones (para cumplimiento fiscal - 7-10 a帽os)
        - Registros de compras 煤nicas (para cumplimiento fiscal)
        - Colecciones de arte e im谩genes capturadas (userId = null, im谩genes preservadas)

        **Importante:**
        - No hay periodo de gracia - la eliminaci贸n es inmediata
        - No es reversible
        - El usuario no podr谩 volver a autenticarse
        - Las im谩genes capturadas se preservan de forma an贸nima
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteAccountRequest'
            example:
              confirmationUserId: '123e4567-e89b-12d3-a456-426614174000'
      responses:
        '200':
          description: Cuenta eliminada exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteAccountResponse'
              example:
                success: true
                message: 'Your account has been successfully deleted'
                deletedAt: '2025-12-22T15:30:00Z'
        '400':
          description: ID de usuario de confirmaci贸n no coincide
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'Bad Request'
                message: 'Confirmation user ID does not match authenticated user'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'Unauthorized'
                message: 'No authentication token provided'
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'Not Found'
                message: 'User not found'

  /api/sync/users/me/push-token:
    post:
      tags:
        - Users
        - Notifications
      summary: Registrar token de notificaciones push
      description: |
        Registra o actualiza el Expo Push Token del dispositivo actual.

        **Uso en la app:**
        - Se llama autom谩ticamente al autenticarse el usuario
        - Se actualiza si el token cambia
        - Un usuario puede tener m煤ltiples tokens (m煤ltiples dispositivos)

        **Backend debe:**
        - Almacenar el token asociado al usuario
        - Actualizar si ya existe un token para el mismo deviceId
        - Mantener m煤ltiples tokens por usuario (para multi-dispositivo)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - deviceId
                - platform
              properties:
                token:
                  type: string
                  example: 'ExponentPushToken[xxxxxxxxxxxxxxxxxxxxxx]'
                  description: 'Expo Push Token obtenido del cliente'
                deviceId:
                  type: string
                  example: 'abc123-device-id'
                  description: 'ID 煤nico del dispositivo'
                platform:
                  type: string
                  enum: [ios, android]
                  example: 'ios'
                  description: 'Plataforma del dispositivo'
                timestamp:
                  type: integer
                  example: 1702987200000
                  description: 'Timestamp de registro en milisegundos'
      responses:
        '200':
          description: Token registrado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  tokenId:
                    type: string
                    example: 'token-uuid-123'
                    description: 'ID del token registrado en la base de datos'
        '400':
          description: Token inv谩lido o datos incorrectos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'BadRequest'
                message: 'Invalid push token format'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Users
        - Notifications
      summary: Eliminar token de notificaciones push
      description: |
        Elimina el token del dispositivo actual.

        **Uso en la app:**
        - Se llama al hacer logout
        - Se llama si el usuario desinstala la app (opcional)

        **Backend debe:**
        - Eliminar el token asociado al deviceId del usuario
        - Dejar de enviar notificaciones a ese token
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: deviceId
          required: true
          schema:
            type: string
          description: 'ID del dispositivo cuyo token se eliminar谩'
          example: 'abc123-device-id'
      responses:
        '200':
          description: Token eliminado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Token no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/sync/users/me/notification-preferences:
    get:
      tags:
        - Users
        - Notifications
      summary: Obtener preferencias de notificaciones
      description: |
        Retorna las preferencias de notificaciones del usuario.

        **Preferencias disponibles:**
        - `dailyArtEnabled`: Si el usuario quiere recibir notificaci贸n diaria de arte
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Preferencias de notificaciones
          content:
            application/json:
              schema:
                type: object
                properties:
                  dailyArtEnabled:
                    type: boolean
                    example: true
                    description: 'Si el usuario quiere recibir notificaci贸n diaria a las 20:00'
              example:
                dailyArtEnabled: true
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      tags:
        - Users
        - Notifications
      summary: Actualizar preferencias de notificaciones
      description: |
        Actualiza las preferencias de notificaciones del usuario.

        **Uso en la app:**
        - Se llama cuando el usuario cambia el toggle en Settings
        - El backend debe actualizar las preferencias en la base de datos
        - El cron job de notificaciones debe respetar estas preferencias
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                dailyArtEnabled:
                  type: boolean
                  example: true
                  description: 'Si el usuario quiere recibir notificaci贸n diaria'
            example:
              dailyArtEnabled: true
      responses:
        '200':
          description: Preferencias actualizadas exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
              example:
                success: true
        '400':
          description: Datos inv谩lidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/sync/categories:
    get:
      tags:
        - Explore
      summary: Obtener todas las categor铆as con jerarqu铆a y traducciones
      description: |
        Retorna el cat谩logo completo de categor铆as de arte con su estructura jer谩rquica.

        **Estructura de jerarqu铆a:**
        - 3 categor铆as principales: Pintura, Escultura, Arquitectura y Monumentos
        - 14 subcategor铆as (per铆odos art铆sticos): Antig眉edad, Renacimiento, Barroco, etc.
        - Cada subcategor铆a pertenece a las 3 categor铆as principales (42 relaciones totales)

        **Uso en la app:**
        - Sincronizaci贸n inicial al instalar la app o login
        - Actualizaci贸n peri贸dica en background sync
        - Filtrado en pantalla Explore por categor铆a/subcategor铆a
        - Navegaci贸n jer谩rquica: Category  Subcategory  Artworks

        **Sync incremental:**
        - Usar campo `updatedAt` para detectar cambios
        - Cachear localmente en SQLite para acceso offline
        - Las traducciones se sirven seg煤n el par谩metro `language`
      parameters:
        - in: query
          name: language
          required: false
          schema:
            type: string
            enum: [es, en]
            default: 'es'
          description: |
            C贸digo ISO 639-1 del idioma para las traducciones de nombres de categor铆as.
            Si no existe traducci贸n para el idioma solicitado, se devuelve espa帽ol por defecto.
      responses:
        '200':
          description: Lista completa de categor铆as con relaciones
          content:
            application/json:
              schema:
                type: object
                properties:
                  categories:
                    type: array
                    items:
                      $ref: '#/components/schemas/CategoryWithRelations'
                    description: 'Array con todas las categor铆as (principales y subcategor铆as)'
                  updatedAt:
                    type: string
                    format: date-time
                    description: 'Timestamp de la 煤ltima actualizaci贸n del cat谩logo (para sync incremental)'
                    example: '2025-12-04T10:30:00Z'
              examples:
                complete_hierarchy:
                  summary: Ejemplo completo con jerarqu铆a de categor铆as
                  value:
                    categories:
                      - id: 'pintura'
                        name: 'Pintura'
                        type: 'category'
                        icon: ''
                        imageUrl: null
                        sortOrder: 1
                        parentIds: []
                        childIds:
                          - 'antiguedad-romana-griega'
                          - 'arte-medieval-romanico'
                          - 'arte-medieval-gotico'
                          - 'renacimiento'
                          - 'manierismo'
                          - 'barroco'
                          - 'rococo'
                          - 'neoclasicismo'
                          - 'romanticismo'
                          - 'realismo'
                          - 'impresionismo-postimpresionismo'
                          - 'modernismo'
                          - 'vanguardias'
                          - 'arte-moderno-contemporaneo'
                        updatedAt: '2025-12-04T10:00:00Z'
                      - id: 'escultura'
                        name: 'Escultura'
                        type: 'category'
                        icon: ''
                        imageUrl: null
                        sortOrder: 2
                        parentIds: []
                        childIds:
                          - 'antiguedad-romana-griega'
                          - 'arte-medieval-romanico'
                          - 'arte-medieval-gotico'
                          - 'renacimiento'
                          - 'manierismo'
                          - 'barroco'
                          - 'rococo'
                          - 'neoclasicismo'
                          - 'romanticismo'
                          - 'realismo'
                          - 'impresionismo-postimpresionismo'
                          - 'modernismo'
                          - 'vanguardias'
                          - 'arte-moderno-contemporaneo'
                        updatedAt: '2025-12-04T10:00:00Z'
                      - id: 'arquitectura-monumentos'
                        name: 'Arquitectura y Monumentos'
                        type: 'category'
                        icon: '锔'
                        imageUrl: null
                        sortOrder: 3
                        parentIds: []
                        childIds:
                          - 'antiguedad-romana-griega'
                          - 'arte-medieval-romanico'
                          - 'arte-medieval-gotico'
                          - 'renacimiento'
                          - 'manierismo'
                          - 'barroco'
                          - 'rococo'
                          - 'neoclasicismo'
                          - 'romanticismo'
                          - 'realismo'
                          - 'impresionismo-postimpresionismo'
                          - 'modernismo'
                          - 'vanguardias'
                          - 'arte-moderno-contemporaneo'
                        updatedAt: '2025-12-04T10:00:00Z'
                      - id: 'renacimiento'
                        name: 'Renacimiento'
                        type: 'subcategory'
                        icon: ''
                        imageUrl: null
                        sortOrder: 4
                        parentIds:
                          - 'pintura'
                          - 'escultura'
                          - 'arquitectura-monumentos'
                        childIds: []
                        updatedAt: '2025-12-04T10:00:00Z'
                      - id: 'barroco'
                        name: 'Barroco'
                        type: 'subcategory'
                        icon: ''
                        imageUrl: null
                        sortOrder: 6
                        parentIds:
                          - 'pintura'
                          - 'escultura'
                          - 'arquitectura-monumentos'
                        childIds: []
                        updatedAt: '2025-12-04T10:00:00Z'
                      - id: 'impresionismo-postimpresionismo'
                        name: 'Impresionismo y Post-Impresionismo'
                        type: 'subcategory'
                        icon: ''
                        imageUrl: null
                        sortOrder: 11
                        parentIds:
                          - 'pintura'
                          - 'escultura'
                          - 'arquitectura-monumentos'
                        childIds: []
                        updatedAt: '2025-12-04T10:00:00Z'
                    updatedAt: '2025-12-04T10:30:00Z'
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Failed to retrieve categories from database'
  /api/sync/user/artworks:
    get:
      tags:
        - Sync
      summary: Sincronizar colecci贸n de artworks del usuario
      description: |
        Retorna todos los artworks identificados por el usuario para sincronizaci贸n con SQLite local.

        **Uso en la app:**
        - Sincronizaci贸n completa al login o instalaci贸n inicial
        - Sincronizaci贸n incremental en background sync cada 15 minutos
        - Cacheo local en tabla `user_artworks` para acceso offline
        - El backend es la fuente de verdad para la colecci贸n del usuario

        **Sync incremental:**
        - Usar campo `updatedAt` para detectar cambios desde 煤ltima sincronizaci贸n
        - Los artworks eliminados en el servidor no aparecer谩n en la respuesta
        - Cliente debe comparar IDs locales vs respuesta para detectar eliminaciones

        **Nota sobre im谩genes:**
        - El endpoint retorna el campo `localUri` con el path local de la imagen en el dispositivo
        - El servidor mantiene sincronizado este path para cada usuario
        - El path sigue el formato: `file:///data/user/0/.../artworks/{userId}/timestamp_capture.jpg`
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: language
          required: false
          schema:
            type: string
            enum: [es, en]
            default: 'es'
          description: |
            C贸digo ISO 639-1 del idioma para las traducciones de descripciones y metadatos.
            Si no existe traducci贸n para el idioma solicitado, se devuelve espa帽ol por defecto.
        - in: query
          name: updatedAfter
          required: false
          schema:
            type: string
            format: date-time
            example: '2025-12-10T10:00:00Z'
          description: |
            Filtro opcional para sincronizaci贸n incremental.
            Retorna solo artworks modificados despu茅s de esta fecha.
            Si no se proporciona, retorna toda la colecci贸n del usuario.
      responses:
        '200':
          description: Array de artworks del usuario para sincronizaci贸n
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required:
                    - id
                    - userId
                    - title
                    - author
                    - identifiedAt
                    - updatedAt
                  properties:
                    id:
                      $ref: '#/components/schemas/UUID'
                      description: 'UUID 煤nico del artwork en la colecci贸n del usuario'
                    userId:
                      $ref: '#/components/schemas/UUID'
                      description: 'UUID del usuario propietario'
                    artworkId:
                      $ref: '#/components/schemas/UUID'
                      nullable: true
                      description: 'ID del artwork en el cat谩logo maestro (null si es custom/no catalogado)'
                    title:
                      type: string
                      example: 'Las Meninas'
                      description: 'T铆tulo de la obra'
                    author:
                      type: string
                      example: 'Diego Vel谩zquez'
                      description: 'Autor/artista de la obra'
                    year:
                      type: string
                      nullable: true
                      example: '1656'
                      description: 'A帽o de creaci贸n'
                    period:
                      type: string
                      nullable: true
                      example: 'Barroco Espa帽ol'
                      description: 'Per铆odo art铆stico o movimiento'
                    technique:
                      type: string
                      nullable: true
                      example: 'leo sobre lienzo'
                      description: 'T茅cnica utilizada'
                    dimensions:
                      type: string
                      nullable: true
                      example: '318 cm  276 cm'
                      description: 'Dimensiones de la obra'
                    country:
                      type: string
                      nullable: true
                      example: 'Espa帽a'
                      description: 'Pa铆s de origen o ubicaci贸n'
                    description:
                      type: string
                      nullable: true
                      example: 'Una de las obras maestras del Siglo de Oro espa帽ol...'
                      description: 'Descripci贸n detallada localizada seg煤n par谩metro language'
                    localUri:
                      type: string
                      nullable: true
                      example: 'file:///data/user/0/com.travelai.app/files/artworks/user123/1702389845123_capture.jpg'
                      description: 'Path local de la imagen capturada en el dispositivo del usuario'
                    identifiedAt:
                      type: string
                      format: date-time
                      example: '2025-12-10T14:30:00Z'
                      description: 'Fecha en que el usuario identific贸/agreg贸 esta obra'
                    createdAt:
                      type: string
                      format: date-time
                      example: '2025-12-10T14:30:00Z'
                      description: 'Fecha de creaci贸n del registro'
                    updatedAt:
                      type: string
                      format: date-time
                      example: '2025-12-10T14:35:00Z'
                      description: 'Fecha de 煤ltima actualizaci贸n (para sync incremental)'
              examples:
                full_sync:
                  summary: Sincronizaci贸n completa (primera vez o sin updatedAfter)
                  value:
                    - id: '550e8400-e29b-41d4-a716-446655440000'
                      userId: '123e4567-e89b-12d3-a456-426614174000'
                      artworkId: 'a1b2c3d4-e5f6-4789-a012-3456789abcde'
                      title: 'Las Meninas'
                      author: 'Diego Vel谩zquez'
                      year: '1656'
                      period: 'Barroco Espa帽ol'
                      technique: 'leo sobre lienzo'
                      dimensions: '318 cm  276 cm'
                      country: 'Espa帽a'
                      description: 'Una de las obras maestras del Siglo de Oro espa帽ol. Muestra a la Infanta Margarita rodeada de sus damas de compa帽铆a (meninas) y otros miembros de la corte, incluido el propio pintor. La compleja composici贸n con m煤ltiples puntos de vista, el uso magistral de la luz, y el espejo que refleja al rey Felipe IV y la reina Mariana de Austria, desaf铆an la percepci贸n del espacio y la realidad.'
                      localUri: 'file:///data/user/0/com.travelai.app/files/artworks/123e4567-e89b-12d3-a456-426614174000/1702389845123_capture.jpg'
                      identifiedAt: '2025-12-10T14:30:00Z'
                      createdAt: '2025-12-10T14:30:00Z'
                      updatedAt: '2025-12-10T14:30:00Z'
                    - id: '660e8400-e29b-41d4-a716-446655440001'
                      userId: '123e4567-e89b-12d3-a456-426614174000'
                      artworkId: 'b2c3d4e5-f6a7-5890-b123-456789abcdef'
                      title: 'La persistencia de la memoria'
                      author: 'Salvador Dal铆'
                      year: '1931'
                      period: 'Surrealismo'
                      technique: 'leo sobre lienzo'
                      dimensions: '24 cm  33 cm'
                      country: 'Espa帽a'
                      description: 'Pintura surrealista ic贸nica que presenta relojes blandos derriti茅ndose en un paisaje on铆rico. La obra explora conceptos de tiempo, memoria y realidad a trav茅s de la imaginer铆a surrealista caracter铆stica de Dal铆.'
                      localUri: 'file:///data/user/0/com.travelai.app/files/artworks/123e4567-e89b-12d3-a456-426614174000/1702308915456_capture.jpg'
                      identifiedAt: '2025-12-09T10:15:00Z'
                      createdAt: '2025-12-09T10:15:00Z'
                      updatedAt: '2025-12-09T10:15:00Z'
                incremental_sync:
                  summary: Sincronizaci贸n incremental (con updatedAfter)
                  value:
                    - id: '660e8400-e29b-41d4-a716-446655440001'
                      userId: '123e4567-e89b-12d3-a456-426614174000'
                      artworkId: 'b2c3d4e5-f6a7-5890-b123-456789abcdef'
                      title: 'La persistencia de la memoria'
                      author: 'Salvador Dal铆'
                      year: '1931'
                      period: 'Surrealismo'
                      technique: 'leo sobre lienzo'
                      dimensions: '24 cm  33 cm'
                      country: 'Espa帽a'
                      description: 'Descripci贸n actualizada con m谩s detalles...'
                      localUri: 'file:///data/user/0/com.travelai.app/files/artworks/123e4567-e89b-12d3-a456-426614174000/1702308915456_capture.jpg'
                      identifiedAt: '2025-12-09T10:15:00Z'
                      createdAt: '2025-12-09T10:15:00Z'
                      updatedAt: '2025-12-10T14:35:00Z'
                empty_collection:
                  summary: Usuario sin artworks en su colecci贸n
                  value: []
        '401':
          description: No autenticado - token JWT inv谩lido o faltante
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Valid authentication token required'
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Failed to retrieve user artworks from database'
  # ----------------------------
  # WEBHOOKS
  # ----------------------------
  /api/webhooks/supabase/user-created:
    post:
      tags:
        - Webhooks
      summary: Webhook para sincronizar usuarios de Supabase Auth
      description: |
        Endpoint llamado autom谩ticamente por Supabase cuando se crea un nuevo usuario.
        Sincroniza el usuario de Supabase Auth con la tabla local de usuarios en Postgres.

        **Configuraci贸n en Supabase:**
        1. Dashboard  Authentication  Webhooks
        2. Crear webhook para evento "User Created" (INSERT on auth.users)
        3. URL: https://api.artexplorer.com/api/webhooks/supabase/user-created
        4. Agregar header: x-webhook-secret con el valor de SUPABASE_WEBHOOK_SECRET

        **Comportamiento:**
        - Crea usuario en tabla local con el mismo UUID de Supabase Auth
        - Extrae email y metadata del perfil (displayName, avatarUrl, language)
        - Es idempotente: llamadas duplicadas son seguras
        - Valida secret para prevenir acceso no autorizado
      security:
        - webhookSecret: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SupabaseWebhookPayload'
            examples:
              user_created:
                summary: Usuario creado con metadata completa (email signup)
                value:
                  type: 'INSERT'
                  table: 'users'
                  record:
                    id: '550e8400-e29b-41d4-a716-446655440000'
                    email: 'john.doe@example.com'
                    raw_user_meta_data:
                      displayName: 'John Doe'
                      avatarUrl: 'https://example.com/avatar.jpg'
                      language: 'es'
                    created_at: '2025-12-01T20:00:00Z'
                  schema: 'auth'
                  old_record: null
              user_created_anonymous:
                summary: Usuario an贸nimo (free trial) creado desde dispositivo
                value:
                  type: 'INSERT'
                  table: 'users'
                  record:
                    id: '650e8400-e29b-41d4-a716-446655440001'
                    email: 'device-abc123@freetrial.travelai.app'
                    raw_user_meta_data:
                      user_type: 'free_trial'
                      device_id: 'abc123-device-uuid'
                      platform: 'ios'
                      is_anonymous: true
                      language: 'en'
                      created_at: '2025-12-03T10:00:00Z'
                    created_at: '2025-12-03T10:00:00Z'
                  schema: 'auth'
                  old_record: null
              user_created_minimal:
                summary: Usuario creado sin metadata opcional (OAuth fallback)
                value:
                  type: 'INSERT'
                  table: 'users'
                  record:
                    id: '550e8400-e29b-41d4-a716-446655440000'
                    email: 'jane.doe@example.com'
                    raw_user_meta_data: null
                    created_at: '2025-12-01T20:00:00Z'
                  schema: 'auth'
                  old_record: null
      responses:
        '200':
          description: Usuario sincronizado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookSuccessResponse'
              example:
                success: true
                message: 'User created successfully'
                userId: '550e8400-e29b-41d4-a716-446655440000'
        '400':
          description: Payload inv谩lido o datos faltantes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'invalid_payload'
                message: 'Missing required field: record.id'
        '401':
          description: Webhook secret inv谩lido o faltante
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Invalid or missing webhook secret'
        '500':
          description: Error interno al crear usuario en base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Failed to create user in database'

  # ----------------------------
  # PAYMENTS & SUBSCRIPTIONS
  # ----------------------------

  /api/payments/create-intent:
    post:
      tags:
        - Payments
      summary: Crear Payment Intent para Travel Pass
      description: |
        Crea un Stripe Payment Intent para la compra 煤nica del Travel Pass.

        **Detalles del Travel Pass:**
        - Precio: 4.99 (pago 煤nico)
        - Duraci贸n: 7 d铆as de acceso premium
        - Sin renovaci贸n autom谩tica

        **Flujo de Pago:**
        1. Cliente llama a este endpoint para crear Payment Intent
        2. Backend retorna credenciales para Stripe Payment Sheet
        3. Cliente inicializa Stripe SDK con credenciales retornadas
        4. Usuario completa el pago en Stripe Payment Sheet
        5. Webhook procesa la confirmaci贸n del pago
        6. Usuario obtiene 7 d铆as de acceso premium

        **Reglas de Negocio:**
        - Usuario no puede tener suscripci贸n o travel pass activo existente
        - Bloquea compras duplicadas mientras el usuario tiene premium activo
        - Crea o recupera cliente de Stripe autom谩ticamente
        - Confirmaci贸n de pago manejada v铆a webhook (payment_intent.succeeded)

        **Rate Limiting:**
        - Se aplican l铆mites est谩ndar de la API
        - Considerar implementar rate limiting adicional para endpoints de pago
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentIntentRequest'
            examples:
              travel_pass:
                summary: Crear payment intent de Travel Pass
                value:
                  planId: 'travel_pass'
                  currency: 'eur'
      responses:
        '200':
          description: Payment Intent creado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentSheetResponse'
              example:
                paymentIntent: 'pi_3QLxyz123_secret_xyz789abc'
                ephemeralKey: 'ek_test_YWJjZGVm'
                customer: 'cus_QtPxyz123ABC'
                publishableKey: 'pk_test_51xyz...'
        '400':
          description: Usuario ya tiene premium activo o solicitud inv谩lida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                already_premium:
                  summary: Usuario ya tiene suscripci贸n o travel pass activo
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'Ya tienes una suscripci贸n o pase activo. Solo puedes tener una suscripci贸n activa a la vez.'
                invalid_plan:
                  summary: PlanId inv谩lido proporcionado
                  value:
                    success: false
                    error: 'validation_error'
                    message: 'planId must be travel_pass for payment intents'
        '401':
          description: No autenticado - token JWT faltante o inv谩lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Valid authentication token required'
        '500':
          description: Error interno del servidor - fallo en API de Stripe o base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Failed to create payment intent'

  /api/payments/setup-intent:
    post:
      tags:
        - Payments
      summary: Crear SetupIntent para Suscripci贸n (Paso 1 de 2)
      description: |
        Crea un Stripe SetupIntent para recolectar m茅todo de pago sin cobrar al usuario.
        Este es el **Paso 1** del flujo de suscripci贸n en 2 pasos.

        **Precios de Suscripci贸n:**
        - Plan Mensual: 8.99/mes (recurrente)
        - Plan Anual: 59.99/a帽o (recurrente)

        **Flujo de Suscripci贸n en 2 Pasos:**

        **Paso 1 (este endpoint)**: Recolectar m茅todo de pago
        1. Cliente llama a este endpoint con el plan deseado
        2. Backend crea SetupIntent (sin cobro)
        3. Cliente inicializa Stripe SetupIntent Sheet
        4. Usuario ingresa detalles de la tarjeta
        5. Stripe guarda el m茅todo de pago
        6. Cliente recibe setupIntentId

        **Paso 2**: Crear suscripci贸n con m茅todo de pago guardado
        - Cliente llama a `/api/payments/create-subscription-with-payment-method`
        - Backend crea suscripci贸n con cobro inmediato
        - Usuario obtiene acceso premium

        **Reglas de Negocio:**
        - Usuario no puede tener suscripci贸n o travel pass activo existente
        - SetupIntent solo guarda m茅todo de pago - NO cobra
        - M茅todo de pago puede usarse despu茅s para crear suscripci贸n
        - SetupIntent tiene usage='off_session' para cobros recurrentes

        **Por qu茅 Flujo en 2 Pasos:**
        - Cumple con requisitos de Strong Customer Authentication (SCA)
        - Permite al usuario revisar detalles de suscripci贸n antes del cobro
        - Proporciona mejor manejo de errores para validaci贸n de m茅todo de pago
        - Habilita creaci贸n fluida de suscripci贸n despu茅s de confirmaci贸n
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSetupIntentRequest'
            examples:
              monthly_plan:
                summary: Configurar m茅todo de pago para suscripci贸n mensual
                value:
                  planId: 'monthly'
              annual_plan:
                summary: Configurar m茅todo de pago para suscripci贸n anual
                value:
                  planId: 'annual'
      responses:
        '200':
          description: SetupIntent creado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SetupIntentResponse'
              example:
                setupIntent: 'seti_1QLxyz123_secret_abc789xyz'
                ephemeralKey: 'ek_test_YWJjZGVm'
                customer: 'cus_QtPxyz123ABC'
                publishableKey: 'pk_test_51xyz...'
        '400':
          description: Usuario ya tiene premium activo o solicitud inv谩lida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                already_premium:
                  summary: Usuario ya tiene suscripci贸n o travel pass activo
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'Ya tienes una suscripci贸n o pase activo. Solo puedes tener una suscripci贸n activa a la vez.'
                invalid_plan:
                  summary: PlanId inv谩lido proporcionado
                  value:
                    success: false
                    error: 'validation_error'
                    message: "planId must be 'monthly' or 'annual'"
        '401':
          description: No autenticado - token JWT faltante o inv谩lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Valid authentication token required'
        '500':
          description: Error interno del servidor - fallo en API de Stripe o base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Failed to create setup intent'

  /api/payments/create-subscription-with-payment-method:
    post:
      tags:
        - Payments
      summary: Crear Suscripci贸n con M茅todo de Pago (Paso 2 de 2)
      description: |
        Crea una Suscripci贸n de Stripe usando un m茅todo de pago guardado.
        Este es el **Paso 2** del flujo de suscripci贸n en 2 pasos.

        **Prerequisitos:**
        - Usuario debe haber completado Paso 1 (POST /api/payments/setup-intent)
        - SetupIntent debe estar en estado 'succeeded'
        - Usuario no debe tener suscripci贸n activa existente

        **Resoluci贸n de M茅todo de Pago:**
        1. **Con setupIntentId** (recomendado): Extrae m茅todo de pago del SetupIntent completado
        2. **Sin setupIntentId**: Usa m茅todo de pago por defecto del cliente o primera tarjeta adjunta

        **Precios de Suscripci贸n:**
        - Plan Mensual: 8.99/mes (cobrado inmediatamente, luego recurrente mensual)
        - Plan Anual: 59.99/a帽o (cobrado inmediatamente, luego recurrente anual)

        **L贸gica de Negocio:**
        1. Valida que usuario no tenga suscripci贸n activa
        2. Recupera/valida m茅todo de pago
        3. Mapea planId a Stripe Price ID desde configuraci贸n de entorno
        4. Crea Suscripci贸n de Stripe (cobro inmediato)
        5. Almacena suscripci贸n en base de datos
        6. Actualiza user.isPremium = true (si suscripci贸n activa)
        7. Retorna detalles de suscripci贸n

        **Webhooks:**
        - `customer.subscription.created`: Confirma creaci贸n de suscripci贸n
        - `invoice.paid`: Confirma pago inicial y renovaciones futuras
        - `invoice.payment_failed`: Maneja pagos fallidos

        **Ciclo de Vida de Suscripci贸n:**
        - Active: Usuario tiene acceso premium
        - Past Due: Pago fall贸, per铆odo de gracia activo
        - Canceled: Usuario o sistema cancel贸 suscripci贸n
        - Expired: Suscripci贸n termin贸 (sin renovaci贸n)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSubscriptionRequest'
            examples:
              with_setup_intent:
                summary: Crear suscripci贸n con SetupIntent (recomendado)
                value:
                  planId: 'monthly'
                  setupIntentId: 'seti_1QLxyz123abc'
              without_setup_intent:
                summary: Crear suscripci贸n con m茅todo de pago por defecto del cliente
                value:
                  planId: 'annual'
      responses:
        '200':
          description: Suscripci贸n creada exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionCreatedResponse'
              examples:
                active_subscription:
                  summary: Suscripci贸n creada y activa
                  value:
                    subscriptionId: 'sub_1QLxyzABC123'
                    status: 'active'
                    currentPeriodEnd: '2026-01-15T14:30:00.000Z'
                incomplete_subscription:
                  summary: Suscripci贸n creada pero pago pendiente
                  value:
                    subscriptionId: 'sub_1QLxyzABC456'
                    status: 'incomplete'
                    currentPeriodEnd: '2026-01-15T14:30:00.000Z'
        '400':
          description: Solicitud inv谩lida o violaci贸n de regla de negocio
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                already_subscribed:
                  summary: Usuario ya tiene suscripci贸n activa
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'Ya tienes una suscripci贸n activa'
                setup_intent_not_completed:
                  summary: SetupIntent a煤n no completado por usuario
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'SetupIntent no completado. Estado: requires_payment_method'
                no_payment_method:
                  summary: No se encontr贸 m茅todo de pago para el cliente
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'No se encontr贸 ning煤n m茅todo de pago para este cliente.'
                payment_method_mismatch:
                  summary: M茅todo de pago pertenece a cliente diferente
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'El m茅todo de pago no pertenece a este cliente'
                price_not_configured:
                  summary: Price ID no configurado en entorno
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'Price ID not configured for plan: monthly'
        '401':
          description: No autenticado - token JWT faltante o inv谩lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Valid authentication token required'
        '500':
          description: Error interno del servidor - fallo en API de Stripe o base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Failed to create subscription'

  /api/payments/subscription/status:
    get:
      tags:
        - Payments
      summary: Obtener Estado de Suscripci贸n del Usuario
      description: |
        Retorna el estado actual de suscripci贸n o travel pass para el usuario autenticado.

        **Prioridad de Estado:**
        1. **Compra nica (Travel Pass)**: Verificada primero
           - Retorna si usuario tiene travel pass activo (validUntil > now, status=succeeded)
           - Retorna: `plan: null, status: 'active', isSubscribed: true`

        2. **Suscripci贸n**: Verificada segundo
           - Retorna si usuario tiene suscripci贸n con estado 'active' o 'past_due'
           - Auto-expira si currentPeriodEnd < now (establece status='expired', isPremium=false)
           - Retorna: `plan: 'monthly'|'annual', status: 'active'|'past_due'|'expired'`

        3. **Sin Premium**: Sin compra o suscripci贸n activa
           - Retorna: `plan: null, status: 'none', isSubscribed: false`

        **Valores de Estado:**
        - `active`: Usuario tiene acceso premium activo
        - `past_due`: Pago de suscripci贸n fall贸, per铆odo de gracia activo
        - `canceled`: Suscripci贸n cancelada, acceso puede continuar hasta fin de per铆odo
        - `expired`: Suscripci贸n o travel pass expirado
        - `none`: Sin suscripci贸n o travel pass

        **Casos de Uso:**
        - Verificar si usuario necesita renovar premium
        - Mostrar detalles de suscripci贸n en configuraci贸n
        - Hacer cumplir acceso a funciones premium
        - Mostrar prompts de actualizaci贸n apropiados

        **Auto-Expiraci贸n:**
        - Si subscription.currentPeriodEnd < now: estado establecido a 'expired', isPremium=false
        - Travel pass auto-expira basado en fecha validUntil
        - Cliente debe llamar peri贸dicamente a este endpoint para sincronizar estado
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Estado de suscripci贸n obtenido exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionStatusResponse'
              examples:
                active_travel_pass:
                  summary: Usuario tiene Travel Pass activo
                  value:
                    plan: null
                    status: 'active'
                    expiryDate: '2025-12-23T14:30:00.000Z'
                    isSubscribed: true
                active_monthly_subscription:
                  summary: Usuario tiene suscripci贸n mensual activa
                  value:
                    plan: 'monthly'
                    status: 'active'
                    expiryDate: '2026-01-15T14:30:00.000Z'
                    isSubscribed: true
                active_annual_subscription:
                  summary: Usuario tiene suscripci贸n anual activa
                  value:
                    plan: 'annual'
                    status: 'active'
                    expiryDate: '2026-12-15T14:30:00.000Z'
                    isSubscribed: true
                past_due_subscription:
                  summary: Pago de suscripci贸n fall贸 (per铆odo de gracia)
                  value:
                    plan: 'monthly'
                    status: 'past_due'
                    expiryDate: '2025-12-15T14:30:00.000Z'
                    isSubscribed: false
                expired_subscription:
                  summary: Suscripci贸n expirada
                  value:
                    plan: 'monthly'
                    status: 'expired'
                    expiryDate: '2025-11-15T14:30:00.000Z'
                    isSubscribed: false
                no_subscription:
                  summary: Usuario no tiene suscripci贸n ni travel pass
                  value:
                    plan: null
                    status: 'none'
                    isSubscribed: false
        '401':
          description: No autenticado - token JWT faltante o inv谩lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Valid authentication token required'
        '500':
          description: Error interno del servidor - fallo en base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Failed to retrieve subscription status'

  /api/payments/subscription/cancel:
    post:
      tags:
        - Payments
      summary: Cancelar Suscripci贸n al Final del Per铆odo
      description: |
        Cancela la suscripci贸n activa del usuario al final del per铆odo de facturaci贸n actual.

        **Comportamiento:**
        - Marca la suscripci贸n para cancelaci贸n en Stripe con `cancel_at_period_end: true`
        - Usuario mantiene acceso premium hasta `currentPeriodEnd`
        - No se emiten reembolsos (pol铆tica de no reembolso)
        - No se realizar谩n m谩s cargos despu茅s del per铆odo actual
        - Webhook `customer.subscription.deleted` se dispara en la fecha de finalizaci贸n

        **Restricciones:**
        - Solo suscripciones mensuales y anuales pueden ser canceladas
        - Travel Pass (compra 煤nica) NO puede ser cancelado ni reembolsado
        - No se puede cancelar una suscripci贸n ya cancelada
        - Usuario debe tener suscripci贸n activa o past_due

        **Flujo de Cancelaci贸n:**
        1. Cliente llama a este endpoint
        2. Backend marca suscripci贸n con `cancel_at_period_end: true` en Stripe
        3. Usuario contin煤a con acceso premium hasta `currentPeriodEnd`
        4. En fecha de expiraci贸n, Stripe dispara webhook `customer.subscription.deleted`
        5. Webhook establece `status: 'canceled'` y `isPremium: false`

        **Despu茅s de Cancelaci贸n:**
        - Estado de suscripci贸n permanece 'active' hasta el fin del per铆odo
        - Para reactivar, usuario debe crear nueva suscripci贸n (no hay reactivaci贸n)
        - `cancel_at_period_end` se puede verificar en respuesta de este endpoint

        **Casos de Uso:**
        - Usuario desea cancelar antes de la pr贸xima renovaci贸n
        - Usuario prob贸 premium y no desea continuar
        - Usuario cambia a diferentes opciones de pago/plan (cancelar primero)
      security:
        - bearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              description: No se requieren par谩metros en el body
            example: {}
      responses:
        '200':
          description: Suscripci贸n marcada para cancelaci贸n exitosamente
          content:
            application/json:
              schema:
                type: object
                required:
                  - success
                  - subscription
                  - message
                properties:
                  success:
                    type: boolean
                    description: Indica si la cancelaci贸n fue exitosa
                    example: true
                  subscription:
                    type: object
                    required:
                      - id
                      - status
                      - cancelAtPeriodEnd
                      - currentPeriodEnd
                      - planId
                    properties:
                      id:
                        type: string
                        description: ID de suscripci贸n de Stripe
                        example: 'sub_1QLxyzABC123'
                      status:
                        type: string
                        description: Estado actual de la suscripci贸n (permanece 'active' hasta el fin del per铆odo)
                        enum: [active, past_due]
                        example: 'active'
                      cancelAtPeriodEnd:
                        type: boolean
                        description: Indica si la suscripci贸n est谩 marcada para cancelaci贸n
                        example: true
                      currentPeriodEnd:
                        type: string
                        format: date-time
                        description: Fecha cuando la suscripci贸n ser谩 cancelada (formato ISO 8601)
                        example: '2026-01-15T14:30:00.000Z'
                      planId:
                        type: string
                        description: Tipo de plan de suscripci贸n
                        enum: [monthly, annual]
                        example: 'monthly'
                  message:
                    type: string
                    description: Mensaje descriptivo sobre la cancelaci贸n
                    example: 'Tu suscripci贸n ser谩 cancelada el 15 de enero de 2026. Seguir谩s teniendo acceso premium hasta esa fecha.'
              examples:
                monthly_subscription_canceled:
                  summary: Suscripci贸n mensual cancelada exitosamente
                  value:
                    success: true
                    subscription:
                      id: 'sub_1QLxyzABC123'
                      status: 'active'
                      cancelAtPeriodEnd: true
                      currentPeriodEnd: '2026-01-15T14:30:00.000Z'
                      planId: 'monthly'
                    message: 'Tu suscripci贸n ser谩 cancelada el 15 de enero de 2026. Seguir谩s teniendo acceso premium hasta esa fecha.'
                annual_subscription_canceled:
                  summary: Suscripci贸n anual cancelada exitosamente
                  value:
                    success: true
                    subscription:
                      id: 'sub_1QLxyzABC456'
                      status: 'active'
                      cancelAtPeriodEnd: true
                      currentPeriodEnd: '2026-12-15T14:30:00.000Z'
                      planId: 'annual'
                    message: 'Tu suscripci贸n ser谩 cancelada el 15 de diciembre de 2026. Seguir谩s teniendo acceso premium hasta esa fecha.'
        '400':
          description: Solicitud inv谩lida - sin suscripci贸n, ya cancelada, o solo Travel Pass
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                no_subscription:
                  summary: Usuario no tiene suscripci贸n activa
                  value:
                    success: false
                    error: 'not_found'
                    message: 'No tienes una suscripci贸n activa'
                already_canceled:
                  summary: Suscripci贸n ya est谩 cancelada
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'La suscripci贸n ya est谩 cancelada'
                travel_pass_only:
                  summary: Usuario solo tiene Travel Pass (no cancelable)
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'No tienes una suscripci贸n activa. Los Travel Pass no pueden ser cancelados.'
                stripe_error:
                  summary: Error al comunicarse con Stripe
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'Error al cancelar la suscripci贸n. Por favor, intenta nuevamente.'
        '401':
          description: No autenticado - token JWT faltante o inv谩lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Valid authentication token required'
        '404':
          description: Suscripci贸n no encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'not_found'
                message: 'No tienes una suscripci贸n activa'
        '500':
          description: Error interno del servidor - fallo en API de Stripe o base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Error al cancelar la suscripci贸n. Por favor, intenta nuevamente.'

  /webhooks/stripe:
    post:
      tags:
        - Webhooks
      summary: Manejador de Eventos Webhook de Stripe
      description: |
        Recibe y procesa eventos webhook de Stripe para confirmaciones de pago y gesti贸n del ciclo de vida de suscripciones.

        **Instrucciones de Configuraci贸n:**
        1. Stripe Dashboard  Developers  Webhooks
        2. Agregar endpoint: https://api.artexplorer.com/webhooks/stripe
        3. Seleccionar eventos (ver lista abajo)
        4. Copiar webhook signing secret a variable de entorno STRIPE_WEBHOOK_SECRET

        **Pruebas Locales:**
        ```bash
        stripe listen --forward-to localhost:3000/webhooks/stripe
        ```

        **Seguridad:**
        - Valida firma webhook usando header `stripe-signature`
        - Requiere request body raw para verificaci贸n de firma
        - Rechaza solicitudes con firma inv谩lida/faltante

        **Eventos Manejados:**

        **Travel Pass (Compra nica):**
        - `payment_intent.succeeded`: Crea registro OneTimePurchase, otorga 7 d铆as premium
        - `payment_intent.payment_failed`: Marca compra como fallida
        - `payment_intent.canceled`: Marca compra como fallida

        **Suscripciones:**
        - `customer.subscription.created`: Crea/actualiza registro de suscripci贸n
        - `customer.subscription.updated`: Actualiza estado y per铆odo de suscripci贸n
        - `customer.subscription.deleted`: Marca suscripci贸n como cancelada
        - `invoice.paid`: Confirma pago, actualiza per铆odo de suscripci贸n
        - `invoice.payment_failed`: Marca suscripci贸n como past_due

        **SetupIntents:**
        - `setup_intent.succeeded`: Registra 茅xito (no se requiere acci贸n)
        - `setup_intent.canceled`: Registra cancelaci贸n (no se requiere acci贸n)

        **Idempotencia:**
        - `payment_intent.succeeded` verifica procesamiento duplicado
        - Seguro recibir el mismo evento m煤ltiples veces

        **Operaciones de Base de Datos:**
        - Crea/actualiza registros OneTimePurchase
        - Crea/actualiza registros Subscription
        - Actualiza User.isPremium basado en estado de pago

        **Manejo de Errores:**
        - Registra todos los errores con contexto
        - Retorna 400 para fallos de validaci贸n de firma
        - Retorna 500 para errores de procesamiento
        - Stripe reintenta webhooks fallidos autom谩ticamente
      requestBody:
        required: true
        description: Evento webhook raw de Stripe (JSON). Debe incluir header stripe-signature para verificaci贸n.
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StripeWebhookEvent'
            examples:
              payment_intent_succeeded:
                summary: Pago de Travel Pass exitoso
                value:
                  type: 'payment_intent.succeeded'
                  data:
                    object:
                      id: 'pi_3QLxyz123'
                      amount: 499
                      currency: 'eur'
                      status: 'succeeded'
                      metadata:
                        userId: '550e8400-e29b-41d4-a716-446655440000'
                        planId: 'travel_pass'
              subscription_created:
                summary: Suscripci贸n creada
                value:
                  type: 'customer.subscription.created'
                  data:
                    object:
                      id: 'sub_1QLxyzABC'
                      customer: 'cus_QtPxyz123'
                      status: 'active'
                      current_period_end: 1705330800
                      items:
                        data:
                          - current_period_end: 1705330800
                      metadata:
                        userId: '550e8400-e29b-41d4-a716-446655440000'
                        planId: 'monthly'
              invoice_paid:
                summary: Factura de suscripci贸n pagada
                value:
                  type: 'invoice.paid'
                  data:
                    object:
                      id: 'in_1QLxyzDEF'
                      customer: 'cus_QtPxyz123'
                      subscription: 'sub_1QLxyzABC'
                      period_end: 1705330800
                      paid: true
      parameters:
        - in: header
          name: stripe-signature
          required: true
          schema:
            type: string
          description: Firma webhook de Stripe para verificaci贸n de eventos
          example: 't=1702389845,v1=abc123...,v0=xyz789...'
      responses:
        '200':
          description: Evento webhook procesado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: boolean
                    example: true
        '400':
          description: Firma webhook inv谩lida o datos requeridos faltantes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missing_signature:
                  summary: Header stripe-signature faltante
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'Missing stripe-signature header'
                invalid_signature:
                  summary: Verificaci贸n de firma webhook fall贸
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'Webhook Error: No signatures found matching the expected signature'
                missing_body:
                  summary: Body raw faltante
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'Missing raw body'
        '500':
          description: Error interno del servidor mientras se procesa webhook
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Error processing webhook event'
