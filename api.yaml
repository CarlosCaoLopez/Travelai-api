openapi: 3.0.3
info:
  title: Art Explorer API
  description: API para la aplicaci칩n de exploraci칩n de arte, gesti칩n de colecciones de usuarios y cat치logo de obras.
  version: 1.0.0
servers:
  - url: https://api.artexplorer.com
    description: Servidor de Producci칩n

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

    webhookSecret:
      type: apiKey
      in: header
      name: x-webhook-secret
      description: Secret key for validating Supabase webhook requests

  schemas:
    # --- Common Types ---
    UUID:
      type: string
      format: uuid
      example: '550e8400-e29b-41d4-a716-446655440000'

    CategoryObject:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        icon:
          type: string

    CategoryWithRelations:
      type: object
      description: 'Categor칤a con su jerarqu칤a de relaciones (padres e hijos)'
      required:
        - id
        - name
        - type
        - icon
        - sortOrder
        - parentIds
        - childIds
        - updatedAt
      properties:
        id:
          type: string
          example: 'pintura'
          description: 'ID 칰nico de la categor칤a'
        name:
          type: string
          description: 'Nombre localizado de la categor칤a seg칰n el par치metro language'
          example: 'Pintura'
        type:
          type: string
          enum: [category, subcategory]
          example: 'category'
          description: "Tipo de categor칤a: 'category' (principal) o 'subcategory' (per칤odo art칤stico)"
        icon:
          type: string
          description: 'Emoji que representa la categor칤a'
          example: '游꿛'
        imageUrl:
          type: string
          nullable: true
          description: 'URL opcional de imagen representativa'
          example: null
        sortOrder:
          type: integer
          example: 1
          description: 'Orden de visualizaci칩n (menor = primero)'
        parentIds:
          type: array
          items:
            type: string
          description: 'IDs de las categor칤as padre (vac칤o para categor칤as principales)'
          example: []
        childIds:
          type: array
          items:
            type: string
          description: 'IDs de las subcategor칤as hijas (vac칤o para subcategor칤as)'
          example:
            [
              'antiguedad-romana-griega',
              'renacimiento',
              'barroco',
              'impresionismo-postimpresionismo',
            ]
        updatedAt:
          type: string
          format: date-time
          example: '2025-12-04T10:30:00Z'
          description: '칔ltima actualizaci칩n para sincronizaci칩n incremental'

    # --- Home Screen ---
    Quote:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/UUID'
        text:
          type: string
          example: 'El arte es la mentira que nos permite conocer la verdad'
        author:
          type: string
          example: 'Pablo Picasso'

    # --- Explore/Locations ---
    LocationSpot:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        description:
          type: string
        category:
          type: string
        distance:
          type: integer
          description: Distancia en metros
        estimatedTime:
          type: string

    # --- Artworks (Catalog) ---
    Artwork:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/UUID'
        title:
          type: string
        author:
          type: string
        year:
          type: string
        country:
          type: string
        period:
          type: string
        technique:
          type: string
        dimensions:
          type: string
        imageUrl:
          type: string
          format: uri
        description:
          type: string
        category:
          $ref: '#/components/schemas/CategoryObject'
        subcategory:
          $ref: '#/components/schemas/CategoryObject'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    # --- User Collection ---
    UserIdentifiedArtwork:
      allOf:
        - $ref: '#/components/schemas/Artwork'
        - type: object
          properties:
            capturedImageUrl:
              type: string
              format: uri
            identifiedAt:
              type: string
              format: date-time

    IdentifyArtworkRequest:
      type: object
      required:
        - capturedImageUrl
        - country
        - category_id
        - subcategory_id
        - title
        - author
        - image_url
      properties:
        capturedImageUrl:
          type: string
          format: uri
        country:
          type: string
        category_id:
          type: string
        subcategory_id:
          type: string
        title:
          type: string
        author:
          type: string
        year:
          type: string
        dimensions:
          type: string
        technique:
          type: string
        image_url:
          type: string # URL de referencia (no la capturada)

    CollectionStats:
      type: object
      properties:
        totalArtworks:
          type: integer
        totalArtists:
          type: integer

    CollectionSummary:
      type: object
      properties:
        stats:
          $ref: '#/components/schemas/CollectionStats'
        artistsInCollection:
          type: array
          items:
            type: object
            properties:
              artist:
                type: string
              artworkCount:
                type: integer
        countriesInCollection:
          type: array
          items:
            type: object
            properties:
              country:
                type: string
              artworkCount:
                type: integer

    # --- Camera Recognition ---
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: 'Invalid image format'
        message:
          type: string
          example: 'The uploaded file must be a valid JPG, PNG, or HEIC image'

    RecognizeArtworkRequest:
      type: object
      required:
        - image
        - localUri
      properties:
        image:
          type: string
          format: binary
          description: 'Imagen capturada del monumento u obra de arte (JPG, PNG, HEIC - m치ximo 10MB)'
        localUri:
          type: string
          description: 'URI local del dispositivo donde se guard칩 la imagen (file:// o content://)'
          example: 'file:///storage/emulated/0/DCIM/Camera/IMG_20241209_153045.jpg'

    RecognizedArtworkData:
      type: object
      description: 'Datos de la obra identificada - null si no se pudo identificar'
      nullable: true
      properties:
        id:
          $ref: '#/components/schemas/UUID'
        title:
          type: string
          example: 'Las Meninas'
        artist:
          type: string
          example: 'Diego Vel치zquez'
        year:
          type: string
          example: '1656'
        period:
          type: string
          example: 'Spanish Baroque'
          description: 'Per칤odo art칤stico o movimiento'
        description:
          type: string
          example: 'One of the masterpieces of the Spanish Golden Age. It shows Infanta Margaret surrounded by her ladies-in-waiting (meninas) and other members of the court, including the painter himself. The complex composition with multiple viewpoints, the masterful use of light, and the mirror reflecting King Philip IV and Queen Mariana of Austria, challenge the perception of space and reality.'
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
          example: 0.98
          description: 'Nivel de confianza del reconocimiento (0.0 - 1.0)'
        tags:
          type: array
          items:
            type: string
          example:
            [
              'Spanish Baroque',
              'Court Portrait',
              'Oil on Canvas',
              '17th Century',
              'Prado Museum',
            ]
          description: 'Categor칤as, estilos y metadata adicional'
        capturedImageUrl:
          type: string
          example: 'file:///storage/emulated/0/DCIM/Camera/IMG_20241209_153045.jpg'
          description: 'URI local del dispositivo donde se encuentra la imagen capturada'
        identifiedAt:
          type: string
          format: date-time
          example: '2025-11-30T14:30:00Z'

    RecognizedArtworkResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
          description: 'Indica si la operaci칩n fue exitosa a nivel t칠cnico'
        identified:
          type: boolean
          example: true
          description: 'Indica si la obra fue identificada por la IA (true) o no se pudo reconocer (false)'
        artwork:
          $ref: '#/components/schemas/RecognizedArtworkData'
        savedToCollection:
          type: boolean
          example: true
          description: 'Indica si la obra se guard칩 en la colecci칩n del usuario (solo true si identified=true)'
        message:
          type: string
          example: 'Artwork successfully identified and saved to collection'
          description: 'Mensaje descriptivo del resultado para el usuario'

    # --- Users ---
    User:
      type: object
      description: 'Datos del perfil del usuario'
      required:
        - id
        - email
        - preferredLanguage
        - isPremium
        - createdAt
      properties:
        id:
          $ref: '#/components/schemas/UUID'
          description: 'UUID del usuario (mismo que en Supabase Auth)'
        email:
          type: string
          format: email
          example: 'user@example.com'
        displayName:
          type: string
          example: 'John Doe'
          nullable: true
          description: 'Nombre visible del usuario'
        preferredLanguage:
          type: string
          enum: [es, en]
          example: 'es'
          description: 'Idioma preferido del usuario (detectado autom치ticamente al registrarse)'
        isPremium:
          type: boolean
          example: false
          description: 'Indica si el usuario tiene suscripci칩n premium activa'
        allowDataCollection:
          type: boolean
          nullable: true
          example: true
          description: 'Permiso para guardar fotos del usuario para mejorar la IA de reconocimiento (null = no se ha preguntado, true = permitido, false = rechazado)'
        createdAt:
          type: string
          format: date-time
          example: '2025-12-01T20:00:00Z'
          description: 'Fecha de creaci칩n de la cuenta'

    UpdateUserRequest:
      type: object
      description: 'Datos para actualizar el perfil del usuario'
      properties:
        displayName:
          type: string
          example: 'Jane Smith'
          nullable: true
        preferredLanguage:
          type: string
          enum: [es, en]
          example: 'en'
          description: 'Cambiar idioma preferido del usuario'
        allowDataCollection:
          type: boolean
          nullable: true
          example: true
          description: 'Permiso para guardar fotos para mejorar la IA de reconocimiento'

    DeleteAccountRequest:
      type: object
      description: 'Datos para confirmar la eliminaci칩n de cuenta'
      required:
        - confirmationUserId
      properties:
        confirmationUserId:
          type: string
          example: '123e4567-e89b-12d3-a456-426614174000'
          description: 'ID del usuario para confirmar la eliminaci칩n (debe coincidir con el usuario autenticado)'

    DeleteAccountResponse:
      type: object
      description: 'Respuesta de eliminaci칩n de cuenta exitosa'
      required:
        - success
        - message
        - deletedAt
      properties:
        success:
          type: boolean
          example: true
          description: 'Indica si la eliminaci칩n fue exitosa'
        message:
          type: string
          example: 'Your account has been successfully deleted'
          description: 'Mensaje de confirmaci칩n'
        deletedAt:
          type: string
          format: date-time
          example: '2025-12-22T15:30:00Z'
          description: 'Timestamp de cu치ndo se elimin칩 la cuenta'

    # --- Webhooks ---
    SupabaseWebhookPayload:
      type: object
      description: 'Payload enviado por Supabase cuando se crea un nuevo usuario'
      required:
        - type
        - table
        - record
        - schema
      properties:
        type:
          type: string
          enum: [INSERT, UPDATE, DELETE]
          example: 'INSERT'
          description: 'Tipo de evento de base de datos'
        table:
          type: string
          example: 'users'
          description: 'Nombre de la tabla afectada'
        record:
          type: object
          description: 'Datos del usuario creado en Supabase Auth'
          required:
            - id
            - email
          properties:
            id:
              $ref: '#/components/schemas/UUID'
              description: 'UUID del usuario en Supabase Auth (usarlo como PK en tabla local)'
            email:
              type: string
              format: email
              example: 'user@example.com'
            raw_user_meta_data:
              type: object
              description: 'Metadata adicional del perfil del usuario'
              properties:
                displayName:
                  type: string
                  example: 'John Doe'
                  nullable: true
                language:
                  type: string
                  enum: [es, en]
                  example: 'es'
                  description: 'Idioma detectado del dispositivo al momento del registro'
                  nullable: false
            created_at:
              type: string
              format: date-time
              example: '2025-12-01T20:00:00Z'
        schema:
          type: string
          example: 'auth'
          description: "Schema de la base de datos (siempre 'auth' para usuarios de Supabase)"
        old_record:
          type: object
          nullable: true
          description: 'Registro anterior (null para INSERT events)'

    WebhookSuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: 'User created successfully'
        userId:
          $ref: '#/components/schemas/UUID'

    # --- Payments/Subscriptions ---
    CreatePaymentIntentRequest:
      type: object
      description: 'Request body para crear Payment Intent de Travel Pass'
      required:
        - planId
      properties:
        planId:
          type: string
          enum: [travel_pass]
          description: 'Identificador del plan - solo se acepta travel_pass para payment intents'
          example: 'travel_pass'
        currency:
          type: string
          default: 'eur'
          description: 'C칩digo de moneda (ISO 4217)'
          example: 'eur'

    PaymentSheetResponse:
      type: object
      description: 'Credenciales para inicializar Stripe Payment Sheet en el cliente'
      required:
        - paymentIntent
        - ephemeralKey
        - customer
        - publishableKey
      properties:
        paymentIntent:
          type: string
          description: 'Payment Intent client_secret (comienza con pi_)'
          example: 'pi_3QLxyz123_secret_xyz789abc'
        ephemeralKey:
          type: string
          description: 'Ephemeral Key secret para autenticaci칩n del Stripe SDK'
          example: 'ek_test_YWJjZGVm'
        customer:
          type: string
          description: 'Stripe Customer ID (comienza con cus_)'
          example: 'cus_QtPxyz123ABC'
        publishableKey:
          type: string
          description: 'Stripe publishable key para inicializar el SDK'
          example: 'pk_test_51xyz...'

    CreateSetupIntentRequest:
      type: object
      description: 'Request body para crear SetupIntent de suscripci칩n (Paso 1/2)'
      required:
        - planId
      properties:
        planId:
          type: string
          enum: [monthly, annual]
          description: 'Identificador del plan de suscripci칩n'
          example: 'monthly'

    SetupIntentResponse:
      type: object
      description: 'Credenciales para inicializar Stripe SetupIntent Sheet en el cliente'
      required:
        - setupIntent
        - ephemeralKey
        - customer
        - publishableKey
      properties:
        setupIntent:
          type: string
          description: 'SetupIntent client_secret (comienza con seti_)'
          example: 'seti_1QLxyz123_secret_abc789xyz'
        ephemeralKey:
          type: string
          description: 'Ephemeral Key secret para autenticaci칩n del Stripe SDK'
          example: 'ek_test_YWJjZGVm'
        customer:
          type: string
          description: 'Stripe Customer ID (comienza con cus_)'
          example: 'cus_QtPxyz123ABC'
        publishableKey:
          type: string
          description: 'Stripe publishable key para inicializar el SDK'
          example: 'pk_test_51xyz...'

    CreateSubscriptionRequest:
      type: object
      description: 'Request body para crear suscripci칩n con m칠todo de pago guardado (Paso 2/2)'
      required:
        - planId
      properties:
        planId:
          type: string
          enum: [monthly, annual]
          description: 'Identificador del plan de suscripci칩n'
          example: 'monthly'
        setupIntentId:
          type: string
          pattern: '^seti_[a-zA-Z0-9_]+$'
          description: 'Opcional: SetupIntent ID para extraer m칠todo de pago (comienza con seti_)'
          example: 'seti_1QLxyz123abc'

    SubscriptionCreatedResponse:
      type: object
      description: 'Respuesta al crear una suscripci칩n exitosamente'
      required:
        - subscriptionId
        - status
        - currentPeriodEnd
      properties:
        subscriptionId:
          type: string
          description: 'Stripe Subscription ID (comienza con sub_)'
          example: 'sub_1QLxyzABC123'
        status:
          type: string
          description: 'Estado actual de la suscripci칩n'
          example: 'active'
        currentPeriodEnd:
          type: string
          format: date-time
          description: 'Fecha ISO 8601 cuando termina el per칤odo de facturaci칩n actual'
          example: '2026-01-15T14:30:00.000Z'

    SubscriptionStatusResponse:
      type: object
      description: 'Estado actual de la suscripci칩n o compra del usuario'
      required:
        - plan
        - status
        - isSubscribed
      properties:
        plan:
          type: string
          enum: [monthly, annual]
          nullable: true
          description: 'Tipo de plan de suscripci칩n (null para travel_pass o sin suscripci칩n)'
          example: 'monthly'
        status:
          type: string
          enum: [active, expired, canceled, past_due, none]
          description: 'Estado actual de la suscripci칩n o compra'
          example: 'active'
        expiryDate:
          type: string
          format: date-time
          nullable: true
          description: 'Fecha ISO 8601 cuando expira la suscripci칩n o compra'
          example: '2026-01-15T14:30:00.000Z'
        isSubscribed:
          type: boolean
          description: 'True si el usuario tiene acceso premium activo actualmente'
          example: true

    StripeWebhookEvent:
      type: object
      description: 'Payload de evento webhook de Stripe'
      required:
        - type
        - data
      properties:
        type:
          type: string
          description: 'Tipo de evento de Stripe'
          example: 'payment_intent.succeeded'
        data:
          type: object
          description: 'Datos del evento conteniendo el objeto de Stripe'

paths:
  # ----------------------------
  # HOME SCREEN
  # ----------------------------
  /api/home/quotes:
    get:
      tags:
        - Home
      summary: Obtener citas de artistas
      parameters:
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
          description: C칩digo ISO 639-1 (es, en, fr)
      responses:
        '200':
          description: Lista de citas
          content:
            application/json:
              schema:
                type: object
                properties:
                  quotes:
                    type: array
                    items:
                      $ref: '#/components/schemas/Quote'

  # ----------------------------
  # CAMERA RECOGNITION
  # ----------------------------
  /api/camera/recognize:
    post:
      tags:
        - Camera Recognition
      summary: Reconocer monumento u obra de arte desde imagen capturada
      description: |
        Recibe una imagen capturada por el usuario, la procesa mediante IA para identificar
        el monumento u obra de arte, y autom치ticamente la guarda en la colecci칩n del usuario
        si es reconocida exitosamente.

        **Flujo:**
        1. Usuario captura foto desde la c치mara y la guarda localmente en el dispositivo
        2. Frontend env칤a imagen (para an치lisis) y localUri (para almacenamiento) como multipart/form-data
        3. Backend procesa imagen con IA y busca coincidencias
        4. Si identifica: guarda localUri en colecci칩n y retorna datos completos
        5. Si no identifica: retorna identified=false con mensaje descriptivo

        **Limitaciones:**
        - Tama침o m치ximo: 10MB
        - Formatos soportados: JPG, PNG, HEIC
        - Rate limiting: 10 requests/minuto (r치fagas)

        **Sistema de Cuotas Diarias (usuarios no-premium):**
        - D칤a 1 de uso: 5 reconocimientos exitosos permitidos
        - D칤a 2 de uso: 2 reconocimientos exitosos permitidos
        - D칤a 3 de uso: 2 reconocimientos exitosos permitidos
        - D칤as 4-30: 1 reconocimiento exitoso por d칤a
        - Despu칠s de 30 d칤as: El ciclo se reinicia autom치ticamente
        - **Nota:** Solo cuentan reconocimientos exitosos (obras realmente identificadas)
        - **Usuarios Premium:** Reconocimientos ilimitados (bypass completo)
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: language
          schema:
            type: string
            pattern: '^[a-z]{2}$'
            default: 'es'
          description: C칩digo ISO 639-1 del idioma (es, en, fr) para los resultados
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/RecognizeArtworkRequest'
            encoding:
              image:
                contentType: image/jpeg, image/png, image/heic
      responses:
        '200':
          description: |
            Operaci칩n exitosa - puede indicar obra identificada (identified=true)
            o no identificada (identified=false)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecognizedArtworkResponse'
              examples:
                identified:
                  summary: Obra identificada exitosamente
                  value:
                    success: true
                    identified: true
                    artwork:
                      id: '550e8400-e29b-41d4-a716-446655440000'
                      title: 'Las Meninas'
                      artist: 'Diego Vel치zquez'
                      year: '1656'
                      period: 'Spanish Baroque'
                      description: 'One of the masterpieces of the Spanish Golden Age. It shows Infanta Margaret surrounded by her ladies-in-waiting (meninas) and other members of the court, including the painter himself. The complex composition with multiple viewpoints, the masterful use of light, and the mirror reflecting King Philip IV and Queen Mariana of Austria, challenge the perception of space and reality.'
                      confidence: 0.98
                      tags:
                        [
                          'Spanish Baroque',
                          'Court Portrait',
                          'Oil on Canvas',
                          '17th Century',
                          'Prado Museum',
                        ]
                      capturedImageUrl: 'https://storage.artexplorer.com/captures/user123/abc123.jpg'
                      identifiedAt: '2025-11-30T14:30:00Z'
                    savedToCollection: true
                    message: 'Artwork successfully identified and saved to collection'
                not_identified:
                  summary: Obra no pudo ser identificada
                  value:
                    success: true
                    identified: false
                    artwork: null
                    savedToCollection: false
                    message: 'Artwork could not be identified. Try with better lighting or a different angle.'
        '400':
          description: Solicitud inv치lida - imagen corrupta, formato no soportado, etc.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_format:
                  summary: Formato de imagen no v치lido
                  value:
                    success: false
                    error: 'invalid_image_format'
                    message: 'The uploaded file must be a valid JPG, PNG, or HEIC image'
                missing_image:
                  summary: Falta el campo image
                  value:
                    success: false
                    error: 'missing_required_field'
                    message: "The 'image' field is required"
        '401':
          description: No autenticado - token JWT inv치lido o faltante
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Valid authentication token required'
        '413':
          description: Payload demasiado grande - imagen excede 10MB
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'payload_too_large'
                message: 'Image file size must not exceed 10MB'
        '403':
          description: Cuota diaria excedida - usuario ha alcanzado su l칤mite de reconocimientos del d칤a
          content:
            application/json:
              schema:
                type: object
                properties:
                  statusCode:
                    type: integer
                    example: 403
                  error:
                    type: string
                    example: 'QuotaExceeded'
                  message:
                    type: string
                    description: Mensaje en el idioma preferido del usuario
                  quotaInfo:
                    type: object
                    properties:
                      hasQuota:
                        type: boolean
                        example: false
                      currentUsageDay:
                        type: integer
                        description: D칤a de uso actual (0=primer d칤a, 1=segundo d칤a, etc.)
                        example: 3
                      dailyLimit:
                        type: integer
                        description: L칤mite diario seg칰n el d칤a de uso
                        example: 1
                      usedToday:
                        type: integer
                        description: Reconocimientos exitosos realizados hoy
                        example: 1
                      remainingToday:
                        type: integer
                        description: Reconocimientos restantes para hoy
                        example: 0
                      resetsAt:
                        type: string
                        format: date-time
                        description: Timestamp cuando resetea la cuota diaria (pr칩ximo d칤a a las 00:00 Madrid)
                        example: '2025-12-28T00:00:00.000Z'
                      cycleResetsAt:
                        type: string
                        format: date-time
                        description: Timestamp cuando resetea el ciclo completo de 30 d칤as
                        example: '2026-01-26T10:30:00.000Z'
                      isPremium:
                        type: boolean
                        example: false
              examples:
                spanish:
                  summary: Usuario en espa침ol alcanz칩 su l칤mite (D칤a 4, 1 reconocimiento usado)
                  value:
                    statusCode: 403
                    error: 'QuotaExceeded'
                    message: 'Has alcanzado tu l칤mite diario de reconocimientos. Intenta ma침ana o mejora a Premium para reconocimientos ilimitados.'
                    quotaInfo:
                      hasQuota: false
                      currentUsageDay: 3
                      dailyLimit: 1
                      usedToday: 1
                      remainingToday: 0
                      resetsAt: '2025-12-28T00:00:00.000Z'
                      cycleResetsAt: '2026-01-26T10:30:00.000Z'
                      isPremium: false
                english:
                  summary: User in English reached daily limit (Day 2, 2 recognitions used)
                  value:
                    statusCode: 403
                    error: 'QuotaExceeded'
                    message: 'You have reached your daily recognition limit. Try again tomorrow or upgrade to Premium for unlimited recognitions.'
                    quotaInfo:
                      hasQuota: false
                      currentUsageDay: 1
                      dailyLimit: 2
                      usedToday: 2
                      remainingToday: 0
                      resetsAt: '2025-12-28T00:00:00.000Z'
                      cycleResetsAt: '2026-01-15T08:45:00.000Z'
                      isPremium: false
                french:
                  summary: Utilisateur en fran칞ais a atteint la limite quotidienne (Jour 1, 5 reconnaissances utilis칠es)
                  value:
                    statusCode: 403
                    error: 'QuotaExceeded'
                    message: 'Vous avez atteint votre limite quotidienne de reconnaissance. R칠essayez demain ou passez  Premium pour des reconnaissances illimit칠es.'
                    quotaInfo:
                      hasQuota: false
                      currentUsageDay: 0
                      dailyLimit: 5
                      usedToday: 5
                      remainingToday: 0
                      resetsAt: '2025-12-28T00:00:00.000Z'
                      cycleResetsAt: '2026-01-20T12:00:00.000Z'
                      isPremium: false
        '429':
          description: Demasiadas solicitudes - rate limit excedido (10 requests/minuto)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'rate_limit_exceeded'
                message: 'Too many requests. Please wait a moment and try again.'
        '500':
          description: Error interno del servidor - fallo en procesamiento IA o base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'An unexpected error occurred while processing the image. Please try again.'

  /api/camera/artwork/details:
    post:
      tags:
        - Camera Recognition
      summary: Obtener informaci칩n detallada de una obra identificada
      description: |
        Recibe informaci칩n b치sica de una obra (t칤tulo, autor, descripci칩n) y retorna
        informaci칩n enriquecida adicional como contexto hist칩rico, t칠cnica, ubicaci칩n,
        obras relacionadas, y datos curiosos.

        **Uso t칤pico:**
        - Usuario ve la informaci칩n inicial de una obra identificada
        - Usuario solicita "m치s informaci칩n" sobre la obra
        - Frontend env칤a los datos b치sicos disponibles
        - Backend enriquece con contexto adicional mediante IA y bases de datos

        **Limitaciones:**
        - Rate limiting aplicado seg칰n tier de suscripci칩n
        - Requiere al menos t칤tulo o autor para funcionar
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: language
          schema:
            type: string
            pattern: '^[a-z]{2}$'
            default: 'es'
          description: C칩digo ISO 639-1 del idioma (es, en, fr) para los resultados enriquecidos
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
              properties:
                title:
                  type: string
                  description: T칤tulo de la obra
                  example: 'Las Meninas'
                artist:
                  type: string
                  description: Nombre del artista/creador
                  example: 'Diego Vel치zquez'
                description:
                  type: string
                  description: Descripci칩n inicial de la obra
                  example: 'One of the masterpieces of the Spanish Golden Age...'
                year:
                  type: string
                  description: A침o de creaci칩n (opcional)
                  example: '1656'
                artworkId:
                  type: string
                  description: ID de la obra en la base de datos (si ya fue identificada previamente)
                  example: '550e8400-e29b-41d4-a716-446655440000'
      responses:
        '200':
          description: Informaci칩n detallada obtenida exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  detailedInfo:
                    type: object
                    properties:
                      historicalContext:
                        type: string
                        description: Contexto hist칩rico y cultural de la 칠poca
                        example: 'Created during the reign of Philip IV of Spain, during the Spanish Golden Age...'
                      visualDescription:
                        type: string
                        description: Descripci칩n visual detallada de la obra (composici칩n, colores, elementos, figuras)
                        example: 'The painting depicts a large room in the Royal Alcazar of Madrid. In the center, the Infanta Margarita Teresa is surrounded by her ladies-in-waiting...'
                      symbolism:
                        type: string
                        description: Simbolismo e interpretaci칩n de la obra
                        example: 'The mirror in the background reflects the royal couple, suggesting multiple perspectives...'
                      interestingFacts:
                        type: array
                        items:
                          type: string
                        example:
                          - 'Picasso created 58 interpretations of Las Meninas in 1957'
                          - 'The painting includes a self-portrait of Vel치zquez himself'
                          - 'It was originally titled "The Family of Philip IV"'
                      artistBio:
                        type: string
                        description: Breve biograf칤a del artista
                        example: 'Diego Rodr칤guez de Silva y Vel치zquez (1599-1660) was a Spanish painter...'
        '400':
          description: Solicitud inv치lida - faltan campos requeridos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'missing_required_field'
                message: 'Title is required to fetch artwork details'
        '401':
          description: No autenticado - token JWT inv치lido o faltante
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Valid authentication token required'
        '404':
          description: Obra no encontrada en la base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'artwork_not_found'
                message: 'Could not find detailed information for the specified artwork'
        '429':
          description: Demasiadas solicitudes - rate limit excedido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'rate_limit_exceeded'
                message: 'Detail request limit reached. Please try again later.'
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'An unexpected error occurred while fetching artwork details'

  # ----------------------------
  # EXPLORE SCREEN
  # ----------------------------

  /api/explore/locations/nearby:
    get:
      tags:
        - Explore
      summary: Obtener lugares culturales cercanos
      parameters:
        - in: query
          name: latitude
          required: true
          schema:
            type: number
            format: float
        - in: query
          name: longitude
          required: true
          schema:
            type: number
            format: float
        - in: query
          name: maxDistance
          schema:
            type: integer
            default: 5000
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
        - in: query
          name: limit
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: Lista de lugares cercanos
          content:
            application/json:
              schema:
                type: object
                properties:
                  locations:
                    type: array
                    items:
                      $ref: '#/components/schemas/LocationSpot'
                  count:
                    type: integer

  /api/explore/artworks:
    get:
      tags:
        - Explore
      summary: Listar obras del cat치logo por categor칤a/pa칤s
      parameters:
        - in: query
          name: category_id
          schema:
            type: string
        - in: query
          name: subcategory_id
          schema:
            type: string
        - in: query
          name: country
          schema:
            type: string
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Lista paginada de obras
          content:
            application/json:
              schema:
                type: object
                properties:
                  artworks:
                    type: array
                    items:
                      $ref: '#/components/schemas/Artwork'
                  pagination:
                    type: object
                    properties:
                      total:
                        type: integer
                      limit:
                        type: integer
                      offset:
                        type: integer
                      hasMore:
                        type: boolean
                  filters:
                    type: object

  # ----------------------------
  # ARTWORKS (CATALOG)
  # ----------------------------
  /api/artworks/{id}:
    get:
      tags:
        - Artworks Catalog
      summary: Obtener detalle de una obra espec칤fica
      parameters:
        - in: path
          name: id
          required: true
          schema:
            $ref: '#/components/schemas/UUID'
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
      responses:
        '200':
          description: Detalle de la obra
          content:
            application/json:
              schema:
                type: object
                properties:
                  artwork:
                    $ref: '#/components/schemas/Artwork'

  /api/artworks/search:
    get:
      tags:
        - Artworks Catalog
      summary: Buscar obras por t칤tulo o autor
      parameters:
        - in: query
          name: q
          required: true
          schema:
            type: string
          description: Query de b칰squeda
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Resultados de b칰squeda
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/Artwork'
                  pagination:
                    type: object
                    properties:
                      total:
                        type: integer
                      limit:
                        type: integer
                      offset:
                        type: integer
                      hasMore:
                        type: boolean
                  query:
                    type: string

  /api/artworks/daily-recommendation:
    get:
      tags:
        - Artworks Catalog
      summary: Obtener recomendaci칩n diaria de obra de arte
      description: |
        Retorna una obra de arte seleccionada aleatoriamente como recomendaci칩n del d칤a.

        **Caracter칤sticas:**
        - La recomendaci칩n se genera autom치ticamente y es la misma para todos los usuarios durante el d칤a
        - Se renueva autom치ticamente cada d칤a
        - Requiere autenticaci칩n JWT
        - Soporta m칰ltiples idiomas para las traducciones

        **Cache:**
        - La recomendaci칩n se cachea en memoria para optimizar rendimiento
        - Cache v치lido hasta que cambie la fecha (UTC)
        - Si el servidor se reinicia, se genera una nueva recomendaci칩n autom치ticamente
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
          description: C칩digo ISO 639-1 del idioma (es, en, fr) para obtener las traducciones
      responses:
        '200':
          description: Recomendaci칩n diaria obtenida exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  artwork:
                    $ref: '#/components/schemas/Artwork'
              example:
                artwork:
                  id: '550e8400-e29b-41d4-a716-446655440000'
                  title: 'La noche estrellada'
                  author: 'Vincent van Gogh'
                  year: '1889'
                  country: 'Francia'
                  period: 'Postimpresionismo'
                  technique: '칍leo sobre lienzo'
                  dimensions: '73.7 cm 칑 92.1 cm'
                  imageUrl: 'https://example.com/starry-night.jpg'
                  description: 'Una de las pinturas m치s famosas del arte moderno...'
                  category:
                    id: 'pintura'
                    name: 'Pintura'
                    icon: '游꿛'
                  createdAt: '2025-01-01T00:00:00Z'
                  updatedAt: '2025-01-01T00:00:00Z'
        '401':
          description: No autenticado - JWT inv치lido o no proporcionado
          content:
            application/json:
              schema:
                type: object
                properties:
                  statusCode:
                    type: integer
                    example: 401
                  message:
                    type: string
                    example: 'Unauthorized'

  # ----------------------------
  # USER COLLECTION
  # ----------------------------
  /api/user/collection:
    get:
      tags:
        - User Collection
      summary: Resumen de la colecci칩n del usuario
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
      responses:
        '200':
          description: Estad칤sticas y grupos de la colecci칩n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CollectionSummary'

  /api/user/collection/artist/{artistName}:
    get:
      tags:
        - User Collection
      summary: Obtener obras de usuario filtradas por artista
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: artistName
          required: true
          schema:
            type: string
          description: Nombre del artista (URL encoded)
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
      responses:
        '200':
          description: Obras del artista en la colecci칩n
          content:
            application/json:
              schema:
                type: object
                properties:
                  artist:
                    type: string
                  artworkCount:
                    type: integer
                  artworks:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserIdentifiedArtwork'

  /api/user/collection/country/{countryName}:
    get:
      tags:
        - User Collection
      summary: Obtener obras de usuario filtradas por pa칤s
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: countryName
          required: true
          schema:
            type: string
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
      responses:
        '200':
          description: Obras del pa칤s en la colecci칩n
          content:
            application/json:
              schema:
                type: object
                properties:
                  country:
                    type: string
                  artworkCount:
                    type: integer
                  artworks:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserIdentifiedArtwork'

  /api/user/collection/recent:
    get:
      tags:
        - User Collection
      summary: Obtener obras recientemente identificadas
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            default: 3
        - in: query
          name: language
          schema:
            type: string
            default: 'es'
      responses:
        '200':
          description: Lista de obras recientes
          content:
            application/json:
              schema:
                type: object
                properties:
                  artworks:
                    type: array
                    items:
                      # Nota: La respuesta de ejemplo muestra una versi칩n simplificada,
                      # pero usaremos el esquema completo para consistencia o una versi칩n parcial inline
                      type: object
                      properties:
                        id:
                          $ref: '#/components/schemas/UUID'
                        title:
                          type: string
                        author:
                          type: string
                        capturedImageUrl:
                          type: string
                        identifiedAt:
                          type: string
                          format: date-time

  /api/user/collection/identify:
    post:
      tags:
        - User Collection
      summary: Guardar una obra identificada en la colecci칩n
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IdentifyArtworkRequest'
      responses:
        '200':
          description: Obra guardada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  artwork:
                    $ref: '#/components/schemas/UserIdentifiedArtwork'
                  updatedStats:
                    $ref: '#/components/schemas/CollectionStats'

  /api/user/collection/{id}:
    delete:
      tags:
        - User Collection
      summary: Eliminar una obra de la colecci칩n
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            $ref: '#/components/schemas/UUID'
      responses:
        '200':
          description: Obra eliminada
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                  deletedId:
                    $ref: '#/components/schemas/UUID'
                  updatedStats:
                    $ref: '#/components/schemas/CollectionStats'

  # ----------------------------
  # SYNC
  # ----------------------------
  /api/sync/users/me:
    get:
      tags:
        - Users
      summary: Obtener perfil del usuario autenticado
      description: |
        Retorna la informaci칩n del perfil del usuario actual.

        **Uso en la app:**
        - Se llama autom치ticamente despu칠s del login para sincronizar datos con SQLite local
        - Los datos se cachean localmente para acceso offline
        - El backend es la fuente de verdad para el perfil del usuario
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Perfil del usuario
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
              example:
                id: '550e8400-e29b-41d4-a716-446655440000'
                email: 'user@example.com'
                displayName: 'John Doe'
                preferredLanguage: 'es'
                isPremium: false
                allowDataCollection: null
                createdAt: '2025-12-01T20:00:00Z'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'Unauthorized'
                message: 'No authentication token provided'

    patch:
      tags:
        - Users
      summary: Actualizar perfil del usuario autenticado
      description: |
        Actualiza la informaci칩n del perfil del usuario actual.

        **Campos actualizables:**
        - `displayName`: Nombre visible del usuario
        - `preferredLanguage`: Idioma preferido (es/en)
        - `allowDataCollection`: Permiso para guardar fotos para mejora de IA (true/false/null)

        **Notas:**
        - Solo se actualizan los campos proporcionados (PATCH parcial)
        - El cambio de idioma afecta el contenido personalizado (quotes, descripciones)
        - La app debe sincronizar los cambios con SQLite local despu칠s de actualizar
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
            examples:
              update_language:
                summary: Cambiar idioma preferido
                value:
                  preferredLanguage: 'en'
              update_profile:
                summary: Actualizar nombre
                value:
                  displayName: 'Jane Smith'
              update_all:
                summary: Actualizar todos los campos
                value:
                  displayName: 'Jane Smith'
                  preferredLanguage: 'en'
                  allowDataCollection: true
      responses:
        '200':
          description: Perfil actualizado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
              example:
                id: '550e8400-e29b-41d4-a716-446655440000'
                email: 'user@example.com'
                displayName: 'Jane Smith'
                preferredLanguage: 'en'
                isPremium: false
                allowDataCollection: true
                createdAt: '2025-12-01T20:00:00Z'
        '400':
          description: Datos inv치lidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'Validation Error'
                message: "preferredLanguage must be 'es' or 'en'"
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'Unauthorized'
                message: 'No authentication token provided'

    delete:
      tags:
        - Users
      summary: Eliminar cuenta de usuario (GDPR/CCPA compliant)
      description: |
        Elimina permanentemente la cuenta del usuario cumpliendo con regulaciones GDPR y CCPA.

        **Proceso de eliminaci칩n:**
        1. Valida que el email de confirmaci칩n coincida con el email del usuario
        2. Elimina el usuario de Supabase Auth (no podr치 volver a autenticarse)
        3. Anonimiza datos personales en la base de datos
        4. Elimina tokens de notificaciones push
        5. Preserva colecciones de arte (im치genes) de forma an칩nima
        6. Preserva registros financieros (subscripciones/compras) anonimizados para cumplimiento legal

        **Datos eliminados:**
        - Email (reemplazado por `deleted_<userId>@deleted.travelai.com`)
        - Nombre visible (`displayName`)
        - Idioma preferido
        - Permisos de recolecci칩n de datos
        - Tokens de notificaciones push
        - Usuario de Supabase Auth

        **Datos preservados (anonimizados):**
        - Registros de subscripciones (para cumplimiento fiscal - 7-10 a침os)
        - Registros de compras 칰nicas (para cumplimiento fiscal)
        - Colecciones de arte e im치genes capturadas (userId = null, im치genes preservadas)

        **Importante:**
        - No hay periodo de gracia - la eliminaci칩n es inmediata
        - No es reversible
        - El usuario no podr치 volver a autenticarse
        - Las im치genes capturadas se preservan de forma an칩nima
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteAccountRequest'
            example:
              confirmationUserId: '123e4567-e89b-12d3-a456-426614174000'
      responses:
        '200':
          description: Cuenta eliminada exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteAccountResponse'
              example:
                success: true
                message: 'Your account has been successfully deleted'
                deletedAt: '2025-12-22T15:30:00Z'
        '400':
          description: ID de usuario de confirmaci칩n no coincide
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'Bad Request'
                message: 'Confirmation user ID does not match authenticated user'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'Unauthorized'
                message: 'No authentication token provided'
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'Not Found'
                message: 'User not found'

  /api/sync/users/me/push-token:
    post:
      tags:
        - Users
        - Notifications
      summary: Registrar token de notificaciones push
      description: |
        Registra o actualiza el Expo Push Token del dispositivo actual.

        **Uso en la app:**
        - Se llama autom치ticamente al autenticarse el usuario
        - Se actualiza si el token cambia
        - Un usuario puede tener m칰ltiples tokens (m칰ltiples dispositivos)

        **Backend debe:**
        - Almacenar el token asociado al usuario
        - Actualizar si ya existe un token para el mismo deviceId
        - Mantener m칰ltiples tokens por usuario (para multi-dispositivo)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - deviceId
                - platform
              properties:
                token:
                  type: string
                  example: 'ExponentPushToken[xxxxxxxxxxxxxxxxxxxxxx]'
                  description: 'Expo Push Token obtenido del cliente'
                deviceId:
                  type: string
                  example: 'abc123-device-id'
                  description: 'ID 칰nico del dispositivo'
                platform:
                  type: string
                  enum: [ios, android]
                  example: 'ios'
                  description: 'Plataforma del dispositivo'
                timestamp:
                  type: integer
                  example: 1702987200000
                  description: 'Timestamp de registro en milisegundos'
      responses:
        '200':
          description: Token registrado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  tokenId:
                    type: string
                    example: 'token-uuid-123'
                    description: 'ID del token registrado en la base de datos'
        '400':
          description: Token inv치lido o datos incorrectos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'BadRequest'
                message: 'Invalid push token format'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Users
        - Notifications
      summary: Eliminar token de notificaciones push
      description: |
        Elimina el token del dispositivo actual.

        **Uso en la app:**
        - Se llama al hacer logout
        - Se llama si el usuario desinstala la app (opcional)

        **Backend debe:**
        - Eliminar el token asociado al deviceId del usuario
        - Dejar de enviar notificaciones a ese token
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: deviceId
          required: true
          schema:
            type: string
          description: 'ID del dispositivo cuyo token se eliminar치'
          example: 'abc123-device-id'
      responses:
        '200':
          description: Token eliminado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Token no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/sync/users/me/notification-preferences:
    get:
      tags:
        - Users
        - Notifications
      summary: Obtener preferencias de notificaciones
      description: |
        Retorna las preferencias de notificaciones del usuario.

        **Preferencias disponibles:**
        - `dailyArtEnabled`: Si el usuario quiere recibir notificaci칩n diaria de arte
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Preferencias de notificaciones
          content:
            application/json:
              schema:
                type: object
                properties:
                  dailyArtEnabled:
                    type: boolean
                    example: true
                    description: 'Si el usuario quiere recibir notificaci칩n diaria a las 20:00'
              example:
                dailyArtEnabled: true
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      tags:
        - Users
        - Notifications
      summary: Actualizar preferencias de notificaciones
      description: |
        Actualiza las preferencias de notificaciones del usuario.

        **Uso en la app:**
        - Se llama cuando el usuario cambia el toggle en Settings
        - El backend debe actualizar las preferencias en la base de datos
        - El cron job de notificaciones debe respetar estas preferencias
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                dailyArtEnabled:
                  type: boolean
                  example: true
                  description: 'Si el usuario quiere recibir notificaci칩n diaria'
            example:
              dailyArtEnabled: true
      responses:
        '200':
          description: Preferencias actualizadas exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
              example:
                success: true
        '400':
          description: Datos inv치lidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/sync/categories:
    get:
      tags:
        - Explore
      summary: Obtener todas las categor칤as con jerarqu칤a y traducciones
      description: |
        Retorna el cat치logo completo de categor칤as de arte con su estructura jer치rquica.

        **Estructura de jerarqu칤a:**
        - 3 categor칤as principales: Pintura, Escultura, Arquitectura y Monumentos
        - 14 subcategor칤as (per칤odos art칤sticos): Antig칲edad, Renacimiento, Barroco, etc.
        - Cada subcategor칤a pertenece a las 3 categor칤as principales (42 relaciones totales)

        **Uso en la app:**
        - Sincronizaci칩n inicial al instalar la app o login
        - Actualizaci칩n peri칩dica en background sync
        - Filtrado en pantalla Explore por categor칤a/subcategor칤a
        - Navegaci칩n jer치rquica: Category  Subcategory  Artworks

        **Sync incremental:**
        - Usar campo `updatedAt` para detectar cambios
        - Cachear localmente en SQLite para acceso offline
        - Las traducciones se sirven seg칰n el par치metro `language`
      parameters:
        - in: query
          name: language
          required: false
          schema:
            type: string
            enum: [es, en]
            default: 'es'
          description: |
            C칩digo ISO 639-1 del idioma para las traducciones de nombres de categor칤as.
            Si no existe traducci칩n para el idioma solicitado, se devuelve espa침ol por defecto.
      responses:
        '200':
          description: Lista completa de categor칤as con relaciones
          content:
            application/json:
              schema:
                type: object
                properties:
                  categories:
                    type: array
                    items:
                      $ref: '#/components/schemas/CategoryWithRelations'
                    description: 'Array con todas las categor칤as (principales y subcategor칤as)'
                  updatedAt:
                    type: string
                    format: date-time
                    description: 'Timestamp de la 칰ltima actualizaci칩n del cat치logo (para sync incremental)'
                    example: '2025-12-04T10:30:00Z'
              examples:
                complete_hierarchy:
                  summary: Ejemplo completo con jerarqu칤a de categor칤as
                  value:
                    categories:
                      - id: 'pintura'
                        name: 'Pintura'
                        type: 'category'
                        icon: '游꿛'
                        imageUrl: null
                        sortOrder: 1
                        parentIds: []
                        childIds:
                          - 'antiguedad-romana-griega'
                          - 'arte-medieval-romanico'
                          - 'arte-medieval-gotico'
                          - 'renacimiento'
                          - 'manierismo'
                          - 'barroco'
                          - 'rococo'
                          - 'neoclasicismo'
                          - 'romanticismo'
                          - 'realismo'
                          - 'impresionismo-postimpresionismo'
                          - 'modernismo'
                          - 'vanguardias'
                          - 'arte-moderno-contemporaneo'
                        updatedAt: '2025-12-04T10:00:00Z'
                      - id: 'escultura'
                        name: 'Escultura'
                        type: 'category'
                        icon: '游'
                        imageUrl: null
                        sortOrder: 2
                        parentIds: []
                        childIds:
                          - 'antiguedad-romana-griega'
                          - 'arte-medieval-romanico'
                          - 'arte-medieval-gotico'
                          - 'renacimiento'
                          - 'manierismo'
                          - 'barroco'
                          - 'rococo'
                          - 'neoclasicismo'
                          - 'romanticismo'
                          - 'realismo'
                          - 'impresionismo-postimpresionismo'
                          - 'modernismo'
                          - 'vanguardias'
                          - 'arte-moderno-contemporaneo'
                        updatedAt: '2025-12-04T10:00:00Z'
                      - id: 'arquitectura-monumentos'
                        name: 'Arquitectura y Monumentos'
                        type: 'category'
                        icon: '游끹勇'
                        imageUrl: null
                        sortOrder: 3
                        parentIds: []
                        childIds:
                          - 'antiguedad-romana-griega'
                          - 'arte-medieval-romanico'
                          - 'arte-medieval-gotico'
                          - 'renacimiento'
                          - 'manierismo'
                          - 'barroco'
                          - 'rococo'
                          - 'neoclasicismo'
                          - 'romanticismo'
                          - 'realismo'
                          - 'impresionismo-postimpresionismo'
                          - 'modernismo'
                          - 'vanguardias'
                          - 'arte-moderno-contemporaneo'
                        updatedAt: '2025-12-04T10:00:00Z'
                      - id: 'renacimiento'
                        name: 'Renacimiento'
                        type: 'subcategory'
                        icon: '游꿠'
                        imageUrl: null
                        sortOrder: 4
                        parentIds:
                          - 'pintura'
                          - 'escultura'
                          - 'arquitectura-monumentos'
                        childIds: []
                        updatedAt: '2025-12-04T10:00:00Z'
                      - id: 'barroco'
                        name: 'Barroco'
                        type: 'subcategory'
                        icon: '游녬'
                        imageUrl: null
                        sortOrder: 6
                        parentIds:
                          - 'pintura'
                          - 'escultura'
                          - 'arquitectura-monumentos'
                        childIds: []
                        updatedAt: '2025-12-04T10:00:00Z'
                      - id: 'impresionismo-postimpresionismo'
                        name: 'Impresionismo y Post-Impresionismo'
                        type: 'subcategory'
                        icon: '游깯'
                        imageUrl: null
                        sortOrder: 11
                        parentIds:
                          - 'pintura'
                          - 'escultura'
                          - 'arquitectura-monumentos'
                        childIds: []
                        updatedAt: '2025-12-04T10:00:00Z'
                    updatedAt: '2025-12-04T10:30:00Z'
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Failed to retrieve categories from database'
  /api/sync/user/artworks:
    get:
      tags:
        - Sync
      summary: Sincronizar colecci칩n de artworks del usuario
      description: |
        Retorna todos los artworks identificados por el usuario para sincronizaci칩n con SQLite local.

        **Uso en la app:**
        - Sincronizaci칩n completa al login o instalaci칩n inicial
        - Sincronizaci칩n incremental en background sync cada 15 minutos
        - Cacheo local en tabla `user_artworks` para acceso offline
        - El backend es la fuente de verdad para la colecci칩n del usuario

        **Sync incremental:**
        - Usar campo `updatedAt` para detectar cambios desde 칰ltima sincronizaci칩n
        - Los artworks eliminados en el servidor no aparecer치n en la respuesta
        - Cliente debe comparar IDs locales vs respuesta para detectar eliminaciones

        **Nota sobre im치genes:**
        - El endpoint retorna el campo `localUri` con el path local de la imagen en el dispositivo
        - El servidor mantiene sincronizado este path para cada usuario
        - El path sigue el formato: `file:///data/user/0/.../artworks/{userId}/timestamp_capture.jpg`
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: language
          required: false
          schema:
            type: string
            enum: [es, en]
            default: 'es'
          description: |
            C칩digo ISO 639-1 del idioma para las traducciones de descripciones y metadatos.
            Si no existe traducci칩n para el idioma solicitado, se devuelve espa침ol por defecto.
        - in: query
          name: updatedAfter
          required: false
          schema:
            type: string
            format: date-time
            example: '2025-12-10T10:00:00Z'
          description: |
            Filtro opcional para sincronizaci칩n incremental.
            Retorna solo artworks modificados despu칠s de esta fecha.
            Si no se proporciona, retorna toda la colecci칩n del usuario.
      responses:
        '200':
          description: Array de artworks del usuario para sincronizaci칩n
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required:
                    - id
                    - userId
                    - title
                    - author
                    - identifiedAt
                    - updatedAt
                  properties:
                    id:
                      $ref: '#/components/schemas/UUID'
                      description: 'UUID 칰nico del artwork en la colecci칩n del usuario'
                    userId:
                      $ref: '#/components/schemas/UUID'
                      description: 'UUID del usuario propietario'
                    artworkId:
                      $ref: '#/components/schemas/UUID'
                      nullable: true
                      description: 'ID del artwork en el cat치logo maestro (null si es custom/no catalogado)'
                    title:
                      type: string
                      example: 'Las Meninas'
                      description: 'T칤tulo de la obra'
                    author:
                      type: string
                      example: 'Diego Vel치zquez'
                      description: 'Autor/artista de la obra'
                    year:
                      type: string
                      nullable: true
                      example: '1656'
                      description: 'A침o de creaci칩n'
                    period:
                      type: string
                      nullable: true
                      example: 'Barroco Espa침ol'
                      description: 'Per칤odo art칤stico o movimiento'
                    technique:
                      type: string
                      nullable: true
                      example: '칍leo sobre lienzo'
                      description: 'T칠cnica utilizada'
                    dimensions:
                      type: string
                      nullable: true
                      example: '318 cm 칑 276 cm'
                      description: 'Dimensiones de la obra'
                    country:
                      type: string
                      nullable: true
                      example: 'Espa침a'
                      description: 'Pa칤s de origen o ubicaci칩n'
                    description:
                      type: string
                      nullable: true
                      example: 'Una de las obras maestras del Siglo de Oro espa침ol...'
                      description: 'Descripci칩n detallada localizada seg칰n par치metro language'
                    localUri:
                      type: string
                      nullable: true
                      example: 'file:///data/user/0/com.travelai.app/files/artworks/user123/1702389845123_capture.jpg'
                      description: 'Path local de la imagen capturada en el dispositivo del usuario'
                    identifiedAt:
                      type: string
                      format: date-time
                      example: '2025-12-10T14:30:00Z'
                      description: 'Fecha en que el usuario identific칩/agreg칩 esta obra'
                    createdAt:
                      type: string
                      format: date-time
                      example: '2025-12-10T14:30:00Z'
                      description: 'Fecha de creaci칩n del registro'
                    updatedAt:
                      type: string
                      format: date-time
                      example: '2025-12-10T14:35:00Z'
                      description: 'Fecha de 칰ltima actualizaci칩n (para sync incremental)'
              examples:
                full_sync:
                  summary: Sincronizaci칩n completa (primera vez o sin updatedAfter)
                  value:
                    - id: '550e8400-e29b-41d4-a716-446655440000'
                      userId: '123e4567-e89b-12d3-a456-426614174000'
                      artworkId: 'a1b2c3d4-e5f6-4789-a012-3456789abcde'
                      title: 'Las Meninas'
                      author: 'Diego Vel치zquez'
                      year: '1656'
                      period: 'Barroco Espa침ol'
                      technique: '칍leo sobre lienzo'
                      dimensions: '318 cm 칑 276 cm'
                      country: 'Espa침a'
                      description: 'Una de las obras maestras del Siglo de Oro espa침ol. Muestra a la Infanta Margarita rodeada de sus damas de compa침칤a (meninas) y otros miembros de la corte, incluido el propio pintor. La compleja composici칩n con m칰ltiples puntos de vista, el uso magistral de la luz, y el espejo que refleja al rey Felipe IV y la reina Mariana de Austria, desaf칤an la percepci칩n del espacio y la realidad.'
                      localUri: 'file:///data/user/0/com.travelai.app/files/artworks/123e4567-e89b-12d3-a456-426614174000/1702389845123_capture.jpg'
                      identifiedAt: '2025-12-10T14:30:00Z'
                      createdAt: '2025-12-10T14:30:00Z'
                      updatedAt: '2025-12-10T14:30:00Z'
                    - id: '660e8400-e29b-41d4-a716-446655440001'
                      userId: '123e4567-e89b-12d3-a456-426614174000'
                      artworkId: 'b2c3d4e5-f6a7-5890-b123-456789abcdef'
                      title: 'La persistencia de la memoria'
                      author: 'Salvador Dal칤'
                      year: '1931'
                      period: 'Surrealismo'
                      technique: '칍leo sobre lienzo'
                      dimensions: '24 cm 칑 33 cm'
                      country: 'Espa침a'
                      description: 'Pintura surrealista ic칩nica que presenta relojes blandos derriti칠ndose en un paisaje on칤rico. La obra explora conceptos de tiempo, memoria y realidad a trav칠s de la imaginer칤a surrealista caracter칤stica de Dal칤.'
                      localUri: 'file:///data/user/0/com.travelai.app/files/artworks/123e4567-e89b-12d3-a456-426614174000/1702308915456_capture.jpg'
                      identifiedAt: '2025-12-09T10:15:00Z'
                      createdAt: '2025-12-09T10:15:00Z'
                      updatedAt: '2025-12-09T10:15:00Z'
                incremental_sync:
                  summary: Sincronizaci칩n incremental (con updatedAfter)
                  value:
                    - id: '660e8400-e29b-41d4-a716-446655440001'
                      userId: '123e4567-e89b-12d3-a456-426614174000'
                      artworkId: 'b2c3d4e5-f6a7-5890-b123-456789abcdef'
                      title: 'La persistencia de la memoria'
                      author: 'Salvador Dal칤'
                      year: '1931'
                      period: 'Surrealismo'
                      technique: '칍leo sobre lienzo'
                      dimensions: '24 cm 칑 33 cm'
                      country: 'Espa침a'
                      description: 'Descripci칩n actualizada con m치s detalles...'
                      localUri: 'file:///data/user/0/com.travelai.app/files/artworks/123e4567-e89b-12d3-a456-426614174000/1702308915456_capture.jpg'
                      identifiedAt: '2025-12-09T10:15:00Z'
                      createdAt: '2025-12-09T10:15:00Z'
                      updatedAt: '2025-12-10T14:35:00Z'
                empty_collection:
                  summary: Usuario sin artworks en su colecci칩n
                  value: []
        '401':
          description: No autenticado - token JWT inv치lido o faltante
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Valid authentication token required'
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Failed to retrieve user artworks from database'
  # ----------------------------
  # WEBHOOKS
  # ----------------------------
  /api/webhooks/supabase/user-created:
    post:
      tags:
        - Webhooks
      summary: Webhook para sincronizar usuarios de Supabase Auth
      description: |
        Endpoint llamado autom치ticamente por Supabase cuando se crea un nuevo usuario.
        Sincroniza el usuario de Supabase Auth con la tabla local de usuarios en Postgres.

        **Configuraci칩n en Supabase:**
        1. Dashboard  Authentication  Webhooks
        2. Crear webhook para evento "User Created" (INSERT on auth.users)
        3. URL: https://api.artexplorer.com/api/webhooks/supabase/user-created
        4. Agregar header: x-webhook-secret con el valor de SUPABASE_WEBHOOK_SECRET

        **Comportamiento:**
        - Crea usuario en tabla local con el mismo UUID de Supabase Auth
        - Extrae email y metadata del perfil (displayName, avatarUrl, language)
        - Es idempotente: llamadas duplicadas son seguras
        - Valida secret para prevenir acceso no autorizado
      security:
        - webhookSecret: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SupabaseWebhookPayload'
            examples:
              user_created:
                summary: Usuario creado con metadata completa (email signup)
                value:
                  type: 'INSERT'
                  table: 'users'
                  record:
                    id: '550e8400-e29b-41d4-a716-446655440000'
                    email: 'john.doe@example.com'
                    raw_user_meta_data:
                      displayName: 'John Doe'
                      avatarUrl: 'https://example.com/avatar.jpg'
                      language: 'es'
                    created_at: '2025-12-01T20:00:00Z'
                  schema: 'auth'
                  old_record: null
              user_created_anonymous:
                summary: Usuario an칩nimo (free trial) creado desde dispositivo
                value:
                  type: 'INSERT'
                  table: 'users'
                  record:
                    id: '650e8400-e29b-41d4-a716-446655440001'
                    email: 'device-abc123@freetrial.travelai.app'
                    raw_user_meta_data:
                      user_type: 'free_trial'
                      device_id: 'abc123-device-uuid'
                      platform: 'ios'
                      is_anonymous: true
                      language: 'en'
                      created_at: '2025-12-03T10:00:00Z'
                    created_at: '2025-12-03T10:00:00Z'
                  schema: 'auth'
                  old_record: null
              user_created_minimal:
                summary: Usuario creado sin metadata opcional (OAuth fallback)
                value:
                  type: 'INSERT'
                  table: 'users'
                  record:
                    id: '550e8400-e29b-41d4-a716-446655440000'
                    email: 'jane.doe@example.com'
                    raw_user_meta_data: null
                    created_at: '2025-12-01T20:00:00Z'
                  schema: 'auth'
                  old_record: null
      responses:
        '200':
          description: Usuario sincronizado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookSuccessResponse'
              example:
                success: true
                message: 'User created successfully'
                userId: '550e8400-e29b-41d4-a716-446655440000'
        '400':
          description: Payload inv치lido o datos faltantes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'invalid_payload'
                message: 'Missing required field: record.id'
        '401':
          description: Webhook secret inv치lido o faltante
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Invalid or missing webhook secret'
        '500':
          description: Error interno al crear usuario en base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Failed to create user in database'

  # ----------------------------
  # PAYMENTS & SUBSCRIPTIONS
  # ----------------------------

  /api/payments/create-intent:
    post:
      tags:
        - Payments
      summary: Crear Payment Intent para Travel Pass
      description: |
        Crea un Stripe Payment Intent para la compra 칰nica del Travel Pass.

        **Detalles del Travel Pass:**
        - Precio: 4.99 (pago 칰nico)
        - Duraci칩n: 7 d칤as de acceso premium
        - Sin renovaci칩n autom치tica

        **Flujo de Pago:**
        1. Cliente llama a este endpoint para crear Payment Intent
        2. Backend retorna credenciales para Stripe Payment Sheet
        3. Cliente inicializa Stripe SDK con credenciales retornadas
        4. Usuario completa el pago en Stripe Payment Sheet
        5. Webhook procesa la confirmaci칩n del pago
        6. Usuario obtiene 7 d칤as de acceso premium

        **Reglas de Negocio:**
        - Usuario no puede tener suscripci칩n o travel pass activo existente
        - Bloquea compras duplicadas mientras el usuario tiene premium activo
        - Crea o recupera cliente de Stripe autom치ticamente
        - Confirmaci칩n de pago manejada v칤a webhook (payment_intent.succeeded)

        **Rate Limiting:**
        - Se aplican l칤mites est치ndar de la API
        - Considerar implementar rate limiting adicional para endpoints de pago
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentIntentRequest'
            examples:
              travel_pass:
                summary: Crear payment intent de Travel Pass
                value:
                  planId: 'travel_pass'
                  currency: 'eur'
      responses:
        '200':
          description: Payment Intent creado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentSheetResponse'
              example:
                paymentIntent: 'pi_3QLxyz123_secret_xyz789abc'
                ephemeralKey: 'ek_test_YWJjZGVm'
                customer: 'cus_QtPxyz123ABC'
                publishableKey: 'pk_test_51xyz...'
        '400':
          description: Usuario ya tiene premium activo o solicitud inv치lida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                already_premium:
                  summary: Usuario ya tiene suscripci칩n o travel pass activo
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'Ya tienes una suscripci칩n o pase activo. Solo puedes tener una suscripci칩n activa a la vez.'
                invalid_plan:
                  summary: PlanId inv치lido proporcionado
                  value:
                    success: false
                    error: 'validation_error'
                    message: 'planId must be travel_pass for payment intents'
        '401':
          description: No autenticado - token JWT faltante o inv치lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Valid authentication token required'
        '500':
          description: Error interno del servidor - fallo en API de Stripe o base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Failed to create payment intent'

  /api/payments/setup-intent:
    post:
      tags:
        - Payments
      summary: Crear SetupIntent para Suscripci칩n (Paso 1 de 2)
      description: |
        Crea un Stripe SetupIntent para recolectar m칠todo de pago sin cobrar al usuario.
        Este es el **Paso 1** del flujo de suscripci칩n en 2 pasos.

        **Precios de Suscripci칩n:**
        - Plan Mensual: 8.99/mes (recurrente)
        - Plan Anual: 59.99/a침o (recurrente)

        **Flujo de Suscripci칩n en 2 Pasos:**

        **Paso 1 (este endpoint)**: Recolectar m칠todo de pago
        1. Cliente llama a este endpoint con el plan deseado
        2. Backend crea SetupIntent (sin cobro)
        3. Cliente inicializa Stripe SetupIntent Sheet
        4. Usuario ingresa detalles de la tarjeta
        5. Stripe guarda el m칠todo de pago
        6. Cliente recibe setupIntentId

        **Paso 2**: Crear suscripci칩n con m칠todo de pago guardado
        - Cliente llama a `/api/payments/create-subscription-with-payment-method`
        - Backend crea suscripci칩n con cobro inmediato
        - Usuario obtiene acceso premium

        **Reglas de Negocio:**
        - Usuario no puede tener suscripci칩n o travel pass activo existente
        - SetupIntent solo guarda m칠todo de pago - NO cobra
        - M칠todo de pago puede usarse despu칠s para crear suscripci칩n
        - SetupIntent tiene usage='off_session' para cobros recurrentes

        **Por qu칠 Flujo en 2 Pasos:**
        - Cumple con requisitos de Strong Customer Authentication (SCA)
        - Permite al usuario revisar detalles de suscripci칩n antes del cobro
        - Proporciona mejor manejo de errores para validaci칩n de m칠todo de pago
        - Habilita creaci칩n fluida de suscripci칩n despu칠s de confirmaci칩n
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSetupIntentRequest'
            examples:
              monthly_plan:
                summary: Configurar m칠todo de pago para suscripci칩n mensual
                value:
                  planId: 'monthly'
              annual_plan:
                summary: Configurar m칠todo de pago para suscripci칩n anual
                value:
                  planId: 'annual'
      responses:
        '200':
          description: SetupIntent creado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SetupIntentResponse'
              example:
                setupIntent: 'seti_1QLxyz123_secret_abc789xyz'
                ephemeralKey: 'ek_test_YWJjZGVm'
                customer: 'cus_QtPxyz123ABC'
                publishableKey: 'pk_test_51xyz...'
        '400':
          description: Usuario ya tiene premium activo o solicitud inv치lida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                already_premium:
                  summary: Usuario ya tiene suscripci칩n o travel pass activo
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'Ya tienes una suscripci칩n o pase activo. Solo puedes tener una suscripci칩n activa a la vez.'
                invalid_plan:
                  summary: PlanId inv치lido proporcionado
                  value:
                    success: false
                    error: 'validation_error'
                    message: "planId must be 'monthly' or 'annual'"
        '401':
          description: No autenticado - token JWT faltante o inv치lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Valid authentication token required'
        '500':
          description: Error interno del servidor - fallo en API de Stripe o base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Failed to create setup intent'

  /api/payments/create-subscription-with-payment-method:
    post:
      tags:
        - Payments
      summary: Crear Suscripci칩n con M칠todo de Pago (Paso 2 de 2)
      description: |
        Crea una Suscripci칩n de Stripe usando un m칠todo de pago guardado.
        Este es el **Paso 2** del flujo de suscripci칩n en 2 pasos.

        **Prerequisitos:**
        - Usuario debe haber completado Paso 1 (POST /api/payments/setup-intent)
        - SetupIntent debe estar en estado 'succeeded'
        - Usuario no debe tener suscripci칩n activa existente

        **Resoluci칩n de M칠todo de Pago:**
        1. **Con setupIntentId** (recomendado): Extrae m칠todo de pago del SetupIntent completado
        2. **Sin setupIntentId**: Usa m칠todo de pago por defecto del cliente o primera tarjeta adjunta

        **Precios de Suscripci칩n:**
        - Plan Mensual: 8.99/mes (cobrado inmediatamente, luego recurrente mensual)
        - Plan Anual: 59.99/a침o (cobrado inmediatamente, luego recurrente anual)

        **L칩gica de Negocio:**
        1. Valida que usuario no tenga suscripci칩n activa
        2. Recupera/valida m칠todo de pago
        3. Mapea planId a Stripe Price ID desde configuraci칩n de entorno
        4. Crea Suscripci칩n de Stripe (cobro inmediato)
        5. Almacena suscripci칩n en base de datos
        6. Actualiza user.isPremium = true (si suscripci칩n activa)
        7. Retorna detalles de suscripci칩n

        **Webhooks:**
        - `customer.subscription.created`: Confirma creaci칩n de suscripci칩n
        - `invoice.paid`: Confirma pago inicial y renovaciones futuras
        - `invoice.payment_failed`: Maneja pagos fallidos

        **Ciclo de Vida de Suscripci칩n:**
        - Active: Usuario tiene acceso premium
        - Past Due: Pago fall칩, per칤odo de gracia activo
        - Canceled: Usuario o sistema cancel칩 suscripci칩n
        - Expired: Suscripci칩n termin칩 (sin renovaci칩n)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSubscriptionRequest'
            examples:
              with_setup_intent:
                summary: Crear suscripci칩n con SetupIntent (recomendado)
                value:
                  planId: 'monthly'
                  setupIntentId: 'seti_1QLxyz123abc'
              without_setup_intent:
                summary: Crear suscripci칩n con m칠todo de pago por defecto del cliente
                value:
                  planId: 'annual'
      responses:
        '200':
          description: Suscripci칩n creada exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionCreatedResponse'
              examples:
                active_subscription:
                  summary: Suscripci칩n creada y activa
                  value:
                    subscriptionId: 'sub_1QLxyzABC123'
                    status: 'active'
                    currentPeriodEnd: '2026-01-15T14:30:00.000Z'
                incomplete_subscription:
                  summary: Suscripci칩n creada pero pago pendiente
                  value:
                    subscriptionId: 'sub_1QLxyzABC456'
                    status: 'incomplete'
                    currentPeriodEnd: '2026-01-15T14:30:00.000Z'
        '400':
          description: Solicitud inv치lida o violaci칩n de regla de negocio
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                already_subscribed:
                  summary: Usuario ya tiene suscripci칩n activa
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'Ya tienes una suscripci칩n activa'
                setup_intent_not_completed:
                  summary: SetupIntent a칰n no completado por usuario
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'SetupIntent no completado. Estado: requires_payment_method'
                no_payment_method:
                  summary: No se encontr칩 m칠todo de pago para el cliente
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'No se encontr칩 ning칰n m칠todo de pago para este cliente.'
                payment_method_mismatch:
                  summary: M칠todo de pago pertenece a cliente diferente
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'El m칠todo de pago no pertenece a este cliente'
                price_not_configured:
                  summary: Price ID no configurado en entorno
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'Price ID not configured for plan: monthly'
        '401':
          description: No autenticado - token JWT faltante o inv치lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Valid authentication token required'
        '500':
          description: Error interno del servidor - fallo en API de Stripe o base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Failed to create subscription'

  /api/payments/subscription/status:
    get:
      tags:
        - Payments
      summary: Obtener Estado de Suscripci칩n del Usuario
      description: |
        Retorna el estado actual de suscripci칩n o travel pass para el usuario autenticado.

        **Prioridad de Estado:**
        1. **Compra 칔nica (Travel Pass)**: Verificada primero
           - Retorna si usuario tiene travel pass activo (validUntil > now, status=succeeded)
           - Retorna: `plan: null, status: 'active', isSubscribed: true`

        2. **Suscripci칩n**: Verificada segundo
           - Retorna si usuario tiene suscripci칩n con estado 'active' o 'past_due'
           - Auto-expira si currentPeriodEnd < now (establece status='expired', isPremium=false)
           - Retorna: `plan: 'monthly'|'annual', status: 'active'|'past_due'|'expired'`

        3. **Sin Premium**: Sin compra o suscripci칩n activa
           - Retorna: `plan: null, status: 'none', isSubscribed: false`

        **Valores de Estado:**
        - `active`: Usuario tiene acceso premium activo
        - `past_due`: Pago de suscripci칩n fall칩, per칤odo de gracia activo
        - `canceled`: Suscripci칩n cancelada, acceso puede continuar hasta fin de per칤odo
        - `expired`: Suscripci칩n o travel pass expirado
        - `none`: Sin suscripci칩n o travel pass

        **Casos de Uso:**
        - Verificar si usuario necesita renovar premium
        - Mostrar detalles de suscripci칩n en configuraci칩n
        - Hacer cumplir acceso a funciones premium
        - Mostrar prompts de actualizaci칩n apropiados

        **Auto-Expiraci칩n:**
        - Si subscription.currentPeriodEnd < now: estado establecido a 'expired', isPremium=false
        - Travel pass auto-expira basado en fecha validUntil
        - Cliente debe llamar peri칩dicamente a este endpoint para sincronizar estado
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Estado de suscripci칩n obtenido exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionStatusResponse'
              examples:
                active_travel_pass:
                  summary: Usuario tiene Travel Pass activo
                  value:
                    plan: null
                    status: 'active'
                    expiryDate: '2025-12-23T14:30:00.000Z'
                    isSubscribed: true
                active_monthly_subscription:
                  summary: Usuario tiene suscripci칩n mensual activa
                  value:
                    plan: 'monthly'
                    status: 'active'
                    expiryDate: '2026-01-15T14:30:00.000Z'
                    isSubscribed: true
                active_annual_subscription:
                  summary: Usuario tiene suscripci칩n anual activa
                  value:
                    plan: 'annual'
                    status: 'active'
                    expiryDate: '2026-12-15T14:30:00.000Z'
                    isSubscribed: true
                past_due_subscription:
                  summary: Pago de suscripci칩n fall칩 (per칤odo de gracia)
                  value:
                    plan: 'monthly'
                    status: 'past_due'
                    expiryDate: '2025-12-15T14:30:00.000Z'
                    isSubscribed: false
                expired_subscription:
                  summary: Suscripci칩n expirada
                  value:
                    plan: 'monthly'
                    status: 'expired'
                    expiryDate: '2025-11-15T14:30:00.000Z'
                    isSubscribed: false
                no_subscription:
                  summary: Usuario no tiene suscripci칩n ni travel pass
                  value:
                    plan: null
                    status: 'none'
                    isSubscribed: false
        '401':
          description: No autenticado - token JWT faltante o inv치lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Valid authentication token required'
        '500':
          description: Error interno del servidor - fallo en base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Failed to retrieve subscription status'

  /api/payments/subscription/cancel:
    post:
      tags:
        - Payments
      summary: Cancelar Suscripci칩n al Final del Per칤odo
      description: |
        Cancela la suscripci칩n activa del usuario al final del per칤odo de facturaci칩n actual.

        **Comportamiento:**
        - Marca la suscripci칩n para cancelaci칩n en Stripe con `cancel_at_period_end: true`
        - Usuario mantiene acceso premium hasta `currentPeriodEnd`
        - No se emiten reembolsos (pol칤tica de no reembolso)
        - No se realizar치n m치s cargos despu칠s del per칤odo actual
        - Webhook `customer.subscription.deleted` se dispara en la fecha de finalizaci칩n

        **Restricciones:**
        - Solo suscripciones mensuales y anuales pueden ser canceladas
        - Travel Pass (compra 칰nica) NO puede ser cancelado ni reembolsado
        - No se puede cancelar una suscripci칩n ya cancelada
        - Usuario debe tener suscripci칩n activa o past_due

        **Flujo de Cancelaci칩n:**
        1. Cliente llama a este endpoint
        2. Backend marca suscripci칩n con `cancel_at_period_end: true` en Stripe
        3. Usuario contin칰a con acceso premium hasta `currentPeriodEnd`
        4. En fecha de expiraci칩n, Stripe dispara webhook `customer.subscription.deleted`
        5. Webhook establece `status: 'canceled'` y `isPremium: false`

        **Despu칠s de Cancelaci칩n:**
        - Estado de suscripci칩n permanece 'active' hasta el fin del per칤odo
        - Para reactivar, usuario debe crear nueva suscripci칩n (no hay reactivaci칩n)
        - `cancel_at_period_end` se puede verificar en respuesta de este endpoint

        **Casos de Uso:**
        - Usuario desea cancelar antes de la pr칩xima renovaci칩n
        - Usuario prob칩 premium y no desea continuar
        - Usuario cambia a diferentes opciones de pago/plan (cancelar primero)
      security:
        - bearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              description: No se requieren par치metros en el body
            example: {}
      responses:
        '200':
          description: Suscripci칩n marcada para cancelaci칩n exitosamente
          content:
            application/json:
              schema:
                type: object
                required:
                  - success
                  - subscription
                  - message
                properties:
                  success:
                    type: boolean
                    description: Indica si la cancelaci칩n fue exitosa
                    example: true
                  subscription:
                    type: object
                    required:
                      - id
                      - status
                      - cancelAtPeriodEnd
                      - currentPeriodEnd
                      - planId
                    properties:
                      id:
                        type: string
                        description: ID de suscripci칩n de Stripe
                        example: 'sub_1QLxyzABC123'
                      status:
                        type: string
                        description: Estado actual de la suscripci칩n (permanece 'active' hasta el fin del per칤odo)
                        enum: [active, past_due]
                        example: 'active'
                      cancelAtPeriodEnd:
                        type: boolean
                        description: Indica si la suscripci칩n est치 marcada para cancelaci칩n
                        example: true
                      currentPeriodEnd:
                        type: string
                        format: date-time
                        description: Fecha cuando la suscripci칩n ser치 cancelada (formato ISO 8601)
                        example: '2026-01-15T14:30:00.000Z'
                      planId:
                        type: string
                        description: Tipo de plan de suscripci칩n
                        enum: [monthly, annual]
                        example: 'monthly'
                  message:
                    type: string
                    description: Mensaje descriptivo sobre la cancelaci칩n
                    example: 'Tu suscripci칩n ser치 cancelada el 15 de enero de 2026. Seguir치s teniendo acceso premium hasta esa fecha.'
              examples:
                monthly_subscription_canceled:
                  summary: Suscripci칩n mensual cancelada exitosamente
                  value:
                    success: true
                    subscription:
                      id: 'sub_1QLxyzABC123'
                      status: 'active'
                      cancelAtPeriodEnd: true
                      currentPeriodEnd: '2026-01-15T14:30:00.000Z'
                      planId: 'monthly'
                    message: 'Tu suscripci칩n ser치 cancelada el 15 de enero de 2026. Seguir치s teniendo acceso premium hasta esa fecha.'
                annual_subscription_canceled:
                  summary: Suscripci칩n anual cancelada exitosamente
                  value:
                    success: true
                    subscription:
                      id: 'sub_1QLxyzABC456'
                      status: 'active'
                      cancelAtPeriodEnd: true
                      currentPeriodEnd: '2026-12-15T14:30:00.000Z'
                      planId: 'annual'
                    message: 'Tu suscripci칩n ser치 cancelada el 15 de diciembre de 2026. Seguir치s teniendo acceso premium hasta esa fecha.'
        '400':
          description: Solicitud inv치lida - sin suscripci칩n, ya cancelada, o solo Travel Pass
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                no_subscription:
                  summary: Usuario no tiene suscripci칩n activa
                  value:
                    success: false
                    error: 'not_found'
                    message: 'No tienes una suscripci칩n activa'
                already_canceled:
                  summary: Suscripci칩n ya est치 cancelada
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'La suscripci칩n ya est치 cancelada'
                travel_pass_only:
                  summary: Usuario solo tiene Travel Pass (no cancelable)
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'No tienes una suscripci칩n activa. Los Travel Pass no pueden ser cancelados.'
                stripe_error:
                  summary: Error al comunicarse con Stripe
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'Error al cancelar la suscripci칩n. Por favor, intenta nuevamente.'
        '401':
          description: No autenticado - token JWT faltante o inv치lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'unauthorized'
                message: 'Valid authentication token required'
        '404':
          description: Suscripci칩n no encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'not_found'
                message: 'No tienes una suscripci칩n activa'
        '500':
          description: Error interno del servidor - fallo en API de Stripe o base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Error al cancelar la suscripci칩n. Por favor, intenta nuevamente.'

  /webhooks/stripe:
    post:
      tags:
        - Webhooks
      summary: Manejador de Eventos Webhook de Stripe
      description: |
        Recibe y procesa eventos webhook de Stripe para confirmaciones de pago y gesti칩n del ciclo de vida de suscripciones.

        **Instrucciones de Configuraci칩n:**
        1. Stripe Dashboard  Developers  Webhooks
        2. Agregar endpoint: https://api.artexplorer.com/webhooks/stripe
        3. Seleccionar eventos (ver lista abajo)
        4. Copiar webhook signing secret a variable de entorno STRIPE_WEBHOOK_SECRET

        **Pruebas Locales:**
        ```bash
        stripe listen --forward-to localhost:3000/webhooks/stripe
        ```

        **Seguridad:**
        - Valida firma webhook usando header `stripe-signature`
        - Requiere request body raw para verificaci칩n de firma
        - Rechaza solicitudes con firma inv치lida/faltante

        **Eventos Manejados:**

        **Travel Pass (Compra 칔nica):**
        - `payment_intent.succeeded`: Crea registro OneTimePurchase, otorga 7 d칤as premium
        - `payment_intent.payment_failed`: Marca compra como fallida
        - `payment_intent.canceled`: Marca compra como fallida

        **Suscripciones:**
        - `customer.subscription.created`: Crea/actualiza registro de suscripci칩n
        - `customer.subscription.updated`: Actualiza estado y per칤odo de suscripci칩n
        - `customer.subscription.deleted`: Marca suscripci칩n como cancelada
        - `invoice.paid`: Confirma pago, actualiza per칤odo de suscripci칩n
        - `invoice.payment_failed`: Marca suscripci칩n como past_due

        **SetupIntents:**
        - `setup_intent.succeeded`: Registra 칠xito (no se requiere acci칩n)
        - `setup_intent.canceled`: Registra cancelaci칩n (no se requiere acci칩n)

        **Idempotencia:**
        - `payment_intent.succeeded` verifica procesamiento duplicado
        - Seguro recibir el mismo evento m칰ltiples veces

        **Operaciones de Base de Datos:**
        - Crea/actualiza registros OneTimePurchase
        - Crea/actualiza registros Subscription
        - Actualiza User.isPremium basado en estado de pago

        **Manejo de Errores:**
        - Registra todos los errores con contexto
        - Retorna 400 para fallos de validaci칩n de firma
        - Retorna 500 para errores de procesamiento
        - Stripe reintenta webhooks fallidos autom치ticamente
      requestBody:
        required: true
        description: Evento webhook raw de Stripe (JSON). Debe incluir header stripe-signature para verificaci칩n.
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StripeWebhookEvent'
            examples:
              payment_intent_succeeded:
                summary: Pago de Travel Pass exitoso
                value:
                  type: 'payment_intent.succeeded'
                  data:
                    object:
                      id: 'pi_3QLxyz123'
                      amount: 499
                      currency: 'eur'
                      status: 'succeeded'
                      metadata:
                        userId: '550e8400-e29b-41d4-a716-446655440000'
                        planId: 'travel_pass'
              subscription_created:
                summary: Suscripci칩n creada
                value:
                  type: 'customer.subscription.created'
                  data:
                    object:
                      id: 'sub_1QLxyzABC'
                      customer: 'cus_QtPxyz123'
                      status: 'active'
                      current_period_end: 1705330800
                      items:
                        data:
                          - current_period_end: 1705330800
                      metadata:
                        userId: '550e8400-e29b-41d4-a716-446655440000'
                        planId: 'monthly'
              invoice_paid:
                summary: Factura de suscripci칩n pagada
                value:
                  type: 'invoice.paid'
                  data:
                    object:
                      id: 'in_1QLxyzDEF'
                      customer: 'cus_QtPxyz123'
                      subscription: 'sub_1QLxyzABC'
                      period_end: 1705330800
                      paid: true
      parameters:
        - in: header
          name: stripe-signature
          required: true
          schema:
            type: string
          description: Firma webhook de Stripe para verificaci칩n de eventos
          example: 't=1702389845,v1=abc123...,v0=xyz789...'
      responses:
        '200':
          description: Evento webhook procesado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: boolean
                    example: true
        '400':
          description: Firma webhook inv치lida o datos requeridos faltantes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missing_signature:
                  summary: Header stripe-signature faltante
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'Missing stripe-signature header'
                invalid_signature:
                  summary: Verificaci칩n de firma webhook fall칩
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'Webhook Error: No signatures found matching the expected signature'
                missing_body:
                  summary: Body raw faltante
                  value:
                    success: false
                    error: 'bad_request'
                    message: 'Missing raw body'
        '500':
          description: Error interno del servidor mientras se procesa webhook
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: 'internal_server_error'
                message: 'Error processing webhook event'
